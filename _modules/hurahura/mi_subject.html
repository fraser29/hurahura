

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hurahura.mi_subject &mdash; hurahura 0.1.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=22607128"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            hurahura
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concept.html">Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_codefree.html">Usage_codefree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_subclass.html">Usage_subclass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_dog.html">Watch Dog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web_interface.html">Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hurahura.html">hurahura package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">hurahura</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hurahura</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">hurahura.mi_subject</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hurahura.mi_subject</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Apr 26 10:59:36 2018</span>

<span class="sd">@author: Fraser M Callaghan</span>

<span class="sd">Classes for building standardised imaging projects. </span>
<span class="sd">Adapted for general use from KMR project. </span>


<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="c1">##</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">spydcmtk</span> <span class="kn">import</span> <span class="n">spydcm</span>
<span class="kn">from</span> <span class="nn">ngawari</span> <span class="kn">import</span> <span class="n">fIO</span>
<span class="kn">import</span> <span class="nn">inspect</span>  

<span class="kn">from</span> <span class="nn">hurahura</span> <span class="kn">import</span> <span class="n">mi_utils</span>


<span class="n">_CACHED_SUBJECT_CLASS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span> <span class="c1"># Sentinel for failed/no config</span>

<div class="viewcode-block" id="get_configured_subject_class">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.get_configured_subject_class">[docs]</a>
<span class="k">def</span> <span class="nf">get_configured_subject_class</span><span class="p">(</span><span class="n">subject_class_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dynamically loads the subject class specified in the MIResearch_config.</span>
<span class="sd">    Falls back to AbstractSubject if not specified or if loading fails.</span>
<span class="sd">    Caches the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_CACHED_SUBJECT_CLASS</span>

    <span class="k">if</span> <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_CACHED_SUBJECT_CLASS</span>
    <span class="k">if</span> <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="ow">is</span> <span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AbstractSubject</span> <span class="c1"># Fallback for previously failed attempt</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span>
    <span class="n">subject_class_name</span> <span class="o">=</span> <span class="n">subject_class_name</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;subject_class_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">subject_class_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">subject_class_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">subject_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="p">,</span> <span class="s1">&#39;class_obj&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subject_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">subject_class_name</span> <span class="o">=</span> <span class="n">subject_obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subject_class_name</span> <span class="o">=</span> <span class="n">subject_obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">subject_obj</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">subject_class_name</span><span class="p">:</span>
        <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="o">=</span> <span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span>
        <span class="c1"># Optionally log that no custom class is configured, using AbstractSubject</span>
        <span class="k">return</span> <span class="n">AbstractSubject</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">subject_class_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">loaded_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="c1"># Ensure it&#39;s a subclass of AbstractSubject (optional but good practice)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">loaded_class</span><span class="p">,</span> <span class="n">AbstractSubject</span><span class="p">):</span>
            <span class="c1"># Log warning: loaded_class is not a subclass of AbstractSubject</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Configured subject class </span><span class="si">{</span><span class="n">subject_class_name</span><span class="si">}</span><span class="s2"> is not a subclass of AbstractSubject. Falling back to AbstractSubject.&quot;</span><span class="p">)</span>
            <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="o">=</span> <span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span>
            <span class="k">return</span> <span class="n">AbstractSubject</span>
        
        <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="o">=</span> <span class="n">loaded_class</span>
        <span class="k">return</span> <span class="n">loaded_class</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log warning: Failed to load subject_class_name, e.g., ModuleNotFound, AttributeError</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Failed to load configured subject class &#39;</span><span class="si">{</span><span class="n">subject_class_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Falling back to AbstractSubject.&quot;</span><span class="p">)</span>
        <span class="n">_CACHED_SUBJECT_CLASS</span> <span class="o">=</span> <span class="n">_SENTINEL_CLASS_NOT_CONFIGURED_OR_FAILED</span>
        <span class="k">return</span> <span class="n">AbstractSubject</span></div>


<span class="c1"># ====================================================================================================</span>
<span class="c1"># ====================================================================================================</span>

<div class="viewcode-block" id="ui_method">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.ui_method">[docs]</a>
<span class="k">def</span> <span class="nf">ui_method</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> 
              <span class="n">category</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;General&quot;</span><span class="p">,</span>
              <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to mark methods that should be available in UI</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        description (str): Description of what the method does</span>
<span class="sd">        category (str): Category for grouping in UI </span>
<span class="sd">        order (int): Display order in UI (lower numbers first)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Set flag that this was called via UI</span>
            <span class="n">wrapper</span><span class="o">.</span><span class="n">_called_via_ui</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">wrapper</span><span class="o">.</span><span class="n">_called_via_ui</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_is_ui_method</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_ui_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_ui_category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_ui_order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_called_via_ui</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="c1"># ====================================================================================================</span>
<span class="c1">#       ABSTRACT SUBJECT CLASS</span>
<span class="c1"># ====================================================================================================</span>
<div class="viewcode-block" id="AbstractSubject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject">[docs]</a>
<span class="k">class</span> <span class="nc">AbstractSubject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract subject controlling most basic structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjectNumber</span><span class="p">,</span> 
                        <span class="n">dataRoot</span><span class="p">,</span> 
                        <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">padZeros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># -- CHECK REQUIRED INPUT --</span>
        <span class="k">if</span> <span class="n">subjectNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Give subjectNumber (as int) or as subjID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span> <span class="o">=</span> <span class="n">dataRoot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjID</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;dataRoot&#39; must be a directory and must exist: Not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># -- PROCESS INPUT ##</span>
        <span class="c1"># A) subjectNumber is an int</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subjN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subjectNumber</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># not given - guess from others in dataRoot</span>
                <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># will raise mi_utils.SubjPrefixError if not obvious</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">subjectPrefix</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># fail on int </span>
            <span class="c1"># B) subjectNumber not an int - then treat as subjectID</span>
            <span class="c1">#       first check if can split to prefix, N, suffix</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefix_N_suffix</span> <span class="o">=</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">subjectNumber</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">prefix_N_suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_subjN</span> <span class="o">=</span> <span class="n">prefix_N_suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix_N_suffix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="n">prefix_N_suffix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">padZeros</span> <span class="o">=</span> <span class="n">findZeroPadding</span><span class="p">(</span><span class="n">subjectNumber</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_subjID</span> <span class="o">=</span> <span class="n">subjectNumber</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
        <span class="k">if</span> <span class="n">padZeros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">padZeros</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">default_pad_zeros</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padZeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">padZeros</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padZeros</span> <span class="o">=</span> <span class="n">padZeros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIRECTORY_STRUCTURE_TREE</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">buildDirectoryStructureTree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BUILD_DIR_IF_NEED</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicomMetaTagListStudy</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">DEFAULT_DICOM_META_TAG_LIST_STUDY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicomMetaTagListSeries</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">DEFAULT_DICOM_META_TAG_LIST_SERIES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_cache</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Class Methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.get_ui_methods">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.get_ui_methods">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_ui_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all methods marked with @ui_method decorator, including inherited ones&quot;&quot;&quot;</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Get all members including inherited ones</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_is_ui_method&#39;</span><span class="p">):</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_ui_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_ui_category&#39;</span><span class="p">,</span> <span class="s1">&#39;General&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_ui_order&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span></div>



    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Overriding methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span> <span class="o">&amp;</span> \
                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPrefix_Number</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">getPrefix_Number</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="AbstractSubject.close">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_logger</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># init must have failed before set _logger to None</span></div>


    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Properties</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjID</span>
        <span class="k">return</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subjN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">padZeros</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padZeros</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    

    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Logging</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rr</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Set propagate to False by default</span>
            
            <span class="c1"># Remove any existing handlers</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            
            <span class="c1"># Add file handler</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfileName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="p">)</span>
            
            <span class="c1"># Add stream handler if not quiet</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
                <span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logfileName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_renameLogger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename the logger - is run from method renameSubjID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfileName</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="p">)</span>


<div class="viewcode-block" id="AbstractSubject.setLoggerDebug">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setLoggerDebug">[docs]</a>
    <span class="k">def</span> <span class="nf">setLoggerDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Remove existing handlers</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            
        <span class="c1"># Add file handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="p">)</span>
        
        <span class="c1"># Add stream handler if not quiet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
            <span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="AbstractSubject.setLoggerInfo">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setLoggerInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">setLoggerInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Remove existing handlers</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            
        <span class="c1"># Add file handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggerFH</span><span class="p">)</span>
        
        <span class="c1"># Add stream handler if not quiet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
            <span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="AbstractSubject.setDEBUGMode">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setDEBUGMode">[docs]</a>
    <span class="k">def</span> <span class="nf">setDEBUGMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="n">DEBUG</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoggerDebug</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logger set to debug mode.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoggerInfo</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractSubject.close_logger">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.close_logger">[docs]</a>
    <span class="k">def</span> <span class="nf">close_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># If does not exist. </span></div>


    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.initDirectoryStructure">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.initDirectoryStructure">[docs]</a>
    <span class="k">def</span> <span class="nf">initDirectoryStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Study participant </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> exists at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2">. Updating directory structure&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIRECTORY_STRUCTURE_TREE</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">childrenList</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory structure correct for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getPrefix_Number">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getPrefix_Number">[docs]</a>
    <span class="k">def</span> <span class="nf">getPrefix_Number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span></div>



    <span class="c1">### LOADING -------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.loadDicomsToSubject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.loadDicomsToSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">loadDicomsToSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicomFolderToLoad</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initDirectoryStructure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoadDicoms to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Don&#39;t log source here as could be identifying</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoadDicoms (</span><span class="si">{</span><span class="n">dicomFolderToLoad</span><span class="si">}</span><span class="s2"> ==&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">()</span><span class="si">}</span><span class="s2">) &amp; anon=</span><span class="si">{</span><span class="n">anonName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
        <span class="n">d0</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">(),</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="n">dicomFolderToLoad</span><span class="p">)</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomStudy</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="n">dicomFolderToLoad</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">HIDE_PROGRESSBAR</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">writeToOrganisedFileStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalLoadSteps</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">dI</span><span class="p">,</span> <span class="n">anonName</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.loadSpydcmStudyToSubject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.loadSpydcmStudyToSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">loadSpydcmStudyToSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spydcmData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initDirectoryStructure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoadDicoms (spydcmtk data ==&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">d0</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">(),</span> <span class="n">spydcmData</span><span class="o">.</span><span class="n">getNumberOfDicoms</span><span class="p">()</span>
        <span class="n">spydcmData</span><span class="o">.</span><span class="n">writeToOrganisedFileStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalLoadSteps</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">dI</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span></div>

    

    <span class="k">def</span> <span class="nf">_finalLoadSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initNumDicoms</span><span class="p">,</span> <span class="n">numDicomsToLoad</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">anonName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">anonName</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">anon_level</span>
        <span class="k">if</span> <span class="n">anonName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anonymise</span><span class="p">(</span><span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
        <span class="n">finalNumDicoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial number of dicoms: </span><span class="si">{</span><span class="n">initNumDicoms</span><span class="si">}</span><span class="s2">, number to load: </span><span class="si">{</span><span class="n">numDicomsToLoad</span><span class="si">}</span><span class="s2">, final number dicoms: </span><span class="si">{</span><span class="n">finalNumDicoms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="n">FORCE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runPostLoadPipeLine</span><span class="p">()</span>


<div class="viewcode-block" id="AbstractSubject.addOtherData">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.addOtherData">[docs]</a>
    <span class="k">def</span> <span class="nf">addOtherData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directoryToLoad</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding other data (non-dicoms) &quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">directoryToLoad</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">directoryToLoad</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRawDirOther</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">directoryToLoad</span><span class="p">)))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directoryToLoad</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.dcm&#39;</span><span class="p">):</span> <span class="c1"># quickly skip dicoms - but still run check below</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dicom</span><span class="o">.</span><span class="n">dcmread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">stop_before_pixels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dicom</span><span class="o">.</span><span class="n">filereader</span><span class="o">.</span><span class="n">InvalidDicomError</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRawDirOther</span><span class="p">(),</span> <span class="n">file</span><span class="p">))</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getRawDirOther</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runPostLoadPipeLine</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractSubject.runPostLoadPipeLine">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.runPostLoadPipeLine">[docs]</a>
    <span class="k">def</span> <span class="nf">runPostLoadPipeLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this is an abstract method for implementation by subclasses</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="AbstractSubject.getLevelCompleted">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getLevelCompleted">[docs]</a>
    <span class="k">def</span> <span class="nf">getLevelCompleted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this is an abstract method for implementation by subclasses</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>

    

<div class="viewcode-block" id="AbstractSubject.getStatus">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getStatus">[docs]</a>
    <span class="k">def</span> <span class="nf">getStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this is an abstract method for implementation by subclasses</span>
        <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span></div>


        
    <span class="c1">### FOLDERS / FILES ------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.exists">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.exists">[docs]</a>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">())</span></div>



<div class="viewcode-block" id="AbstractSubject.getTopDir">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getTopDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getTopDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">_getDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listOfDirsBeyondStudyDir</span><span class="p">,</span> <span class="n">BUILD_IF_NEED</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">listOfDirsBeyondStudyDir</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_getDir takes a list as first argument&quot;</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="o">*</span><span class="n">listOfDirsBeyondStudyDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">BUILD_IF_NEED</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILD_DIR_IF_NEED</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dd</span>


<div class="viewcode-block" id="AbstractSubject.getMetaDir">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getMetaDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">META</span><span class="p">])</span></div>



<div class="viewcode-block" id="AbstractSubject.getRawDir">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getRawDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getRawDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">RAW</span><span class="p">])</span></div>



<div class="viewcode-block" id="AbstractSubject.getRawDirOther">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getRawDirOther">[docs]</a>
    <span class="k">def</span> <span class="nf">getRawDirOther</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BUILD_IF_NEED</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">OTHER</span><span class="p">],</span> <span class="n">BUILD_IF_NEED</span><span class="o">=</span><span class="n">BUILD_IF_NEED</span><span class="p">)</span></div>

    

<div class="viewcode-block" id="AbstractSubject.getDicomsDir">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomsDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomsDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDicomsDir</span><span class="p">()</span></div>

    

    <span class="k">def</span> <span class="nf">__getDicomsDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dirName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">DICOM</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dirName</span>
    

<div class="viewcode-block" id="AbstractSubject.renameSubjID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.renameSubjID">[docs]</a>
    <span class="k">def</span> <span class="nf">renameSubjID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newSubjID</span><span class="p">):</span>
        <span class="n">oldID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span>
        <span class="k">if</span> <span class="n">newSubjID</span> <span class="o">==</span> <span class="n">oldID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not rename from </span><span class="si">{</span><span class="n">oldID</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">newSubjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing subjID from </span><span class="si">{</span><span class="n">oldID</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">newSubjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; *** THIS WILL LIKELY HAVE BREAKING CONSEQUENCES ***&quot;</span><span class="p">)</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">newSubjID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newName</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">newName</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">newName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">newSubjID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjN</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_renameLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New logger after subjID changed from </span><span class="si">{</span><span class="n">oldID</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; *** THIS WILL LIKELY HAVE BREAKING CONSEQUENCES ***&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="n">FORCE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



    <span class="c1">### META STUFF -----------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSeriesMetaCSV">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSeriesMetaCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="s1">&#39;ScanSeriesInfo.csv&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getSeriesMetaAsDataFrame">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSeriesMetaAsDataFrame">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaAsDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">(),</span>  <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.buildSeriesDataMetaCSV">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.buildSeriesDataMetaCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FORCE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">FORCE</span><span class="p">):</span>
            <span class="k">return</span> 
        <span class="n">seInfoList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmSE</span> <span class="ow">in</span> <span class="n">dcmStudy</span><span class="p">:</span>
                <span class="n">iSerDict</span> <span class="o">=</span> <span class="n">dcmSE</span><span class="o">.</span><span class="n">getSeriesInfoDict</span><span class="p">(</span><span class="n">extraTags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SeriesNumber&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;SeriesDescription&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;StudyDate&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;AcquisitionTime&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;InPlanePhaseEncodingDirection&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;PixelBandwidth&quot;</span><span class="p">,</span>
                                                            <span class="p">])</span>
                <span class="n">seInfoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSerDict</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">seInfoList</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;buildSeriesDataMetaCSV&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.infoFull">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.infoFull">[docs]</a>
    <span class="k">def</span> <span class="nf">infoFull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInfoStr</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printDicomsInfo</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractSubject.info">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.info">[docs]</a>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return info string for this subject</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInfoStr</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span></div>



<div class="viewcode-block" id="AbstractSubject.printDicomsInfo">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.printDicomsInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">printDicomsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dicomFolderList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dicomFolderList</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomSeriesNumber_Interactive">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomSeriesNumber_Interactive">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesNumber_Interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printDicomsInfo</span><span class="p">()</span>
        <span class="n">seNum</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the dicom series number: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">seNum</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getStartTime_EndTimeOfExam">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getStartTime_EndTimeOfExam">[docs]</a>
    <span class="k">def</span> <span class="nf">getStartTime_EndTimeOfExam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListOfSeNums</span><span class="p">()</span>
        <span class="n">Ns</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">NN</span><span class="p">)</span>
        <span class="n">Ne</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NN</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">Ne</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="n">Ne</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">))</span>
        <span class="n">endT_HHMMSS</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">endT</span><span class="p">,</span> <span class="s1">&#39;%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">Ns</span><span class="p">),</span> <span class="n">endT_HHMMSS</span></div>



<div class="viewcode-block" id="AbstractSubject.getTimeTakenForSeriesN_s">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getTimeTakenForSeriesN_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;ScanDuration&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getHRForSeriesN">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getHRForSeriesN">[docs]</a>
    <span class="k">def</span> <span class="nf">getHRForSeriesN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;HeartRate&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getStartTimeForSeriesN_HHMMSS">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getStartTimeForSeriesN_HHMMSS">[docs]</a>
    <span class="k">def</span> <span class="nf">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;AcquisitionTime&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getDifferenceBetweenStartTimesOfTwoScans_s">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDifferenceBetweenStartTimesOfTwoScans_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getDifferenceBetweenStartTimesOfTwoScans_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seN1</span><span class="p">,</span> <span class="n">seN2</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">seN1</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">seN2</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span></div>



<div class="viewcode-block" id="AbstractSubject.getTotalScanTime_s">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getTotalScanTime_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getTotalScanTime_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListOfSeNums</span><span class="p">()</span>
        <span class="n">se</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">se</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">]</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDifferenceBetweenStartTimesOfTwoScans_s</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">se</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">se</span><span class="p">))</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">se</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span></div>



<div class="viewcode-block" id="AbstractSubject.getSeriesMetaValue">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSeriesMetaValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seNum</span><span class="p">,</span> <span class="n">varName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get meta value for given series naumber</span>

<span class="sd">        Args:</span>
<span class="sd">            seNum (int): series number</span>
<span class="sd">            varName (str): tag name, from: EchoTime FlipAngle HeartRate</span>
<span class="sd">                InPlanePhaseEncodingDirection InternalPulseSequenceName PulseSequenceName</span>
<span class="sd">                RepetitionTime ScanDuration SeriesDescription</span>
<span class="sd">                SeriesNumber SpacingBetweenSlices StartTime</span>
<span class="sd">                dCol dRow dSlice dTime</span>
<span class="sd">                nCols nRow nSlice nTime</span>

<span class="sd">        Returns:</span>
<span class="sd">            ANY: tag value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seNum</span><span class="p">,</span> <span class="n">varName</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomSeriesMetaList">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomSeriesMetaList">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesMetaList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()[</span><span class="s1">&#39;Series&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomSeriesMeta">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomSeriesMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seriesDescription</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seriesNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">seriesDescription</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;parameter seriesNumber OR seriesDescription must be given&quot;</span><span class="p">)</span>
        <span class="n">allSeries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesMetaList</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">seriesNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thisSeries</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allSeries</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">seriesNumber</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seD</span> <span class="o">=</span> <span class="n">seriesDescription</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">thisSeries</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allSeries</span> <span class="k">if</span> <span class="n">seD</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;SeriesDescription&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">thisSeries</span></div>



<div class="viewcode-block" id="AbstractSubject.getMetaTagsFile">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getMetaTagsFile">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaTagsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">Tags</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.setTagValue">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setTagValue">[docs]</a>
    <span class="nd">@ui_method</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Set tag value&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Meta&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="n">tag</span><span class="p">:</span><span class="n">value</span><span class="p">},</span> <span class="n">suffix</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getTagValue">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getTagValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="n">metaSuffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="c1"># FIXME is this done correctly</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="p">,</span> <span class="n">metaSuffix</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">_cacheMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagsFile</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ff</span><span class="p">):</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">fIO</span><span class="o">.</span><span class="n">parseJsonToDictionary</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_cache</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>


<div class="viewcode-block" id="AbstractSubject.getMetaDict">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getMetaDict">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get meta json file as dictionary. Will check if cached. </span>

<span class="sd">        Args:</span>
<span class="sd">            suffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Meta json file </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cacheMeta</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_cache</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span></div>



<div class="viewcode-block" id="AbstractSubject.getMetaTagValue">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getMetaTagValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metaSuffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get specific tag from meta json file</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (str): Name of tag to return</span>
<span class="sd">            NOT_FOUND (ANY, optional): A default value to return if &quot;tag&quot; not found. Defaults to None.</span>
<span class="sd">            metaSuffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            e: OSError if meta json file not found</span>

<span class="sd">        Returns:</span>
<span class="sd">            ANY: tag value from json file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">(</span><span class="n">metaSuffix</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">NOT_FOUND</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NOT_FOUND</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>



<div class="viewcode-block" id="AbstractSubject.updateMetaFile">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.updateMetaFile">[docs]</a>
    <span class="k">def</span> <span class="nf">updateMetaFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metaDict</span><span class="p">,</span> <span class="n">metasuffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the meta json file</span>

<span class="sd">        Args:</span>
<span class="sd">            metaDict (dict): dictionary with key value pairs to update</span>
<span class="sd">            metasuffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Full path of file updated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">(</span><span class="n">metasuffix</span><span class="p">)</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metaDict</span><span class="p">)</span>
        <span class="n">metaFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagsFile</span><span class="p">(</span><span class="n">metasuffix</span><span class="p">)</span>
        <span class="n">fIO</span><span class="o">.</span><span class="n">writeDictionaryToJSON</span><span class="p">(</span><span class="n">metaFile</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updated meta-file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cacheMeta</span><span class="p">(</span><span class="n">metasuffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metaFile</span></div>



<div class="viewcode-block" id="AbstractSubject.buildDicomMeta">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.buildDicomMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">buildDicomMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds a JSON file comprised of DICOM tags and some derived values. </span>
<span class="sd">        All data is taken from DICOM files - StudyDate, PatientID, MagneticFieldStrength etc</span>
<span class="sd">        A &#39;Series&#39; tag is populated with a list of all series with series information (same as found in ScanSeriesInfo.csv)</span>

<span class="sd">        NOTE: miresearch expects one study (scanner exam instance) per subjectID. </span>
<span class="sd">        There are occasions where multiple studies occur but should be treated as one study. </span>
<span class="sd">        E.g.: the subject got off the table and then resummed the study later. </span>
<span class="sd">        miresearch will account for this by recording tags from the first found &#39;study&#39; at the study level and </span>
<span class="sd">        from ALL found series to populate the list of series. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this uses pydicom - so tag names are different.</span>
        <span class="n">ddFull</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SubjectID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">,</span> <span class="s1">&#39;SubjN&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjN</span><span class="p">,</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dcmDict</span> <span class="o">=</span> <span class="n">dcmStudies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getStudySummaryDict</span><span class="p">(</span><span class="n">extraTags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dicomMetaTagListStudy</span><span class="p">)</span>
            <span class="n">dcmDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Series&#39;</span><span class="p">)</span> <span class="c1"># Get more detailed series information</span>
            <span class="n">ddFull</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dcmDict</span><span class="p">)</span>
            <span class="c1"># </span>
            <span class="k">for</span> <span class="n">iDcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">iDcmStudy</span><span class="p">:</span>
                    <span class="n">serDict</span> <span class="o">=</span> <span class="n">iSeries</span><span class="o">.</span><span class="n">getSeriesInfoDict</span><span class="p">(</span><span class="n">extraTags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dicomMetaTagListSeries</span><span class="p">)</span>
                    <span class="n">serDict</span><span class="p">[</span><span class="s1">&#39;DicomFileName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iSeries</span><span class="o">.</span><span class="n">getDicomFullFileName</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ddFull</span><span class="p">[</span><span class="s1">&#39;Series&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serDict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Found no Dicoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">(</span><span class="n">ddFull</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.countNumberOfDicoms">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.countNumberOfDicoms">[docs]</a>
    <span class="k">def</span> <span class="nf">countNumberOfDicoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__getDicomsDir</span><span class="p">())</span></div>



<div class="viewcode-block" id="AbstractSubject.findDicomSeries">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.findDicomSeries">[docs]</a>
    <span class="k">def</span> <span class="nf">findDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesDescription</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">seriesDescription</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">seriesDescription</span> <span class="o">=</span> <span class="p">[</span><span class="n">seriesDescription</span><span class="p">]</span>
        <span class="n">seriesDescription_</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seriesDescription</span><span class="p">]</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;Series&quot;</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">possibles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">iDescriptionStr_</span> <span class="o">=</span> <span class="n">iSeries</span><span class="p">[</span><span class="s1">&#39;SeriesDescription&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="ow">in</span> <span class="n">iDescriptionStr_</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seriesDescription_</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">tf</span><span class="p">):</span>
                <span class="n">relPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">iSeries</span><span class="p">[</span><span class="s1">&#39;DicomFileName&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">relPath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="n">relPath</span> <span class="o">=</span> <span class="n">relPath</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Remove leading slash</span>
                <span class="n">absPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">relPath</span><span class="p">)</span>
                <span class="n">possibles</span><span class="p">[</span><span class="n">iSeries</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">absPath</span>
        <span class="k">return</span> <span class="n">possibles</span></div>



<div class="viewcode-block" id="AbstractSubject.getSeriesNumbersMatchingDescriptionStr">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSeriesNumbersMatchingDescriptionStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptionStr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findDicomSeries</span><span class="p">(</span><span class="n">descriptionStr</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomSeriesDir_Description">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomSeriesDir_Description">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesDir_Description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesDescription</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="n">seriesDescription</span><span class="p">)</span>
        <span class="n">seNs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">seN</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seNs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seN</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomSeriesDir">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomSeriesDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesNum</span><span class="p">,</span> <span class="n">seriesUID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">ONE_FILE_PER_DIR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dcmSeries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">seriesUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
                <span class="n">dcmSeries</span> <span class="o">=</span> <span class="n">dcmStudy</span><span class="o">.</span><span class="n">getSeriesByUID</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## ERROR: Series with UID: </span><span class="si">{</span><span class="n">seriesUID</span><span class="si">}</span><span class="s2"> NOT FOUND&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
                <span class="n">dcmSeries</span> <span class="o">=</span> <span class="n">dcmStudy</span><span class="o">.</span><span class="n">getSeriesByID</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## ERROR: Series with SE number: </span><span class="si">{</span><span class="n">seriesNum</span><span class="si">}</span><span class="s2"> NOT FOUND&quot;</span><span class="p">)</span>
        <span class="n">dirName</span> <span class="o">=</span> <span class="n">dcmSeries</span><span class="o">.</span><span class="n">getRootDir</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dirName</span></div>



<div class="viewcode-block" id="AbstractSubject.hasDicomSeries">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.hasDicomSeries">[docs]</a>
    <span class="k">def</span> <span class="nf">hasDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesDescription</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findDicomSeries</span><span class="p">(</span><span class="n">seriesDescription</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> </div>



<div class="viewcode-block" id="AbstractSubject.getDicomFile">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomFile">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesNum</span><span class="p">,</span> <span class="n">instanceNum</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;Series&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">iSeries</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">seriesNum</span><span class="p">:</span>
                <span class="n">dicomf</span> <span class="o">=</span> <span class="n">iSeries</span><span class="p">[</span><span class="s1">&#39;DicomFileName&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dicomf</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">root</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dicomf</span><span class="p">)</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">file_parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">file_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">instanceNum</span><span class="si">:</span><span class="s2">04d</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="AbstractSubject.getDicomFoldersListStr">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getDicomFoldersListStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomFoldersListStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FULL</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">excludeSeNums</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dFolders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">ONE_FILE_PER_DIR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">dcmStudy</span><span class="p">:</span>
                <span class="n">dFolders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSeries</span><span class="o">.</span><span class="n">getRootDir</span><span class="p">())</span>
        <span class="n">dS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dFolders</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">instanceNumberSortKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">FULL</span><span class="p">:</span>
            <span class="n">dS</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dS</span><span class="p">]</span>
            <span class="n">dS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">return</span> <span class="n">dS</span>
        <span class="k">if</span> <span class="n">excludeSeNums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">excludeSeNums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seN</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">seN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">dcmDirList</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seN</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludeSeNums</span><span class="p">]</span>
        <span class="c1"># dcmDirList = sorted(dcmDirList, key=spydcm.dcmTools.instanceNumberSortKey)</span>
        <span class="k">return</span> <span class="n">dcmDirList</span></div>



<div class="viewcode-block" id="AbstractSubject.getListOfSeNums">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getListOfSeNums">[docs]</a>
    <span class="k">def</span> <span class="nf">getListOfSeNums</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">se</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="n">FULL</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">se</span></div>



<div class="viewcode-block" id="AbstractSubject.getStudyID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getStudyID">[docs]</a>
    <span class="k">def</span> <span class="nf">getStudyID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">studyID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;StudyID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">studyID</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">studyID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;ScannerStudyID&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">studyID</span></div>

    
    
<div class="viewcode-block" id="AbstractSubject.getSeriesDescriptionsStr">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSeriesDescriptionsStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesDescriptionsStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="n">FULL</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>



<div class="viewcode-block" id="AbstractSubject.getStudyDate">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getStudyDate">[docs]</a>
    <span class="k">def</span> <span class="nf">getStudyDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RETURN_Datetime</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">dos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RETURN_Datetime</span><span class="p">:</span>
            <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">dos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dos</span></div>



<div class="viewcode-block" id="AbstractSubject.getInfoStr">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getInfoStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getInfoStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extraKeys</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># Return values_list, info_keys:</span>
        <span class="c1">#   list of values for info keys (+ age). </span>
        <span class="c1">#   header keys</span>
        <span class="n">infoKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SubjectID&#39;</span><span class="p">,</span> <span class="s1">&#39;SubjN&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientBirthDate&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientSex&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">extraKeys</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getAge</span><span class="p">()</span><span class="si">:</span><span class="s2">5.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">nDCM</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infoKeys</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">aa</span><span class="p">,</span> <span class="n">nDCM</span><span class="p">],</span> <span class="n">infoKeys</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;TotalDicoms&#39;</span><span class="p">]</span></div>



    <span class="c1"># ------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.anonymise">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.anonymise">[docs]</a>
    <span class="nd">@ui_method</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Anonymise subject&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Anonymisation&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">anonymise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonID</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if anonName is valid and return anonName and anonID</span>
<span class="sd">        If anonName = SOFT then set an encoded name in meta file and retain PatientID - anonymise DICOMS</span>
<span class="sd">        If anonName = HARD then set encoded name in meta file to &quot;Unknown&quot; - anonymise DICOMS</span>
<span class="sd">        If anonName is None then anonymise DICOMS</span>
<span class="sd">        Else anonymise DICOMS with anonName for Name and PatientID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if called via UI</span>
        <span class="n">called_via_ui</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymise</span><span class="p">,</span> <span class="s1">&#39;_called_via_ui&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">called_via_ui</span><span class="p">:</span>
            <span class="n">QUIET</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">firstNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName_FirstNames</span><span class="p">()</span>
        <span class="n">anonName</span><span class="p">,</span> <span class="n">anonIDt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkAnonName</span><span class="p">(</span><span class="n">anonName</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">firstNames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAge</span><span class="p">()})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anonID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">anonID</span> <span class="o">=</span> <span class="n">anonIDt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Begin anonymise in place. New name: &quot;</span><span class="si">{</span><span class="n">anonName</span><span class="si">}</span><span class="s1">&quot;, anonID: &quot;</span><span class="si">{</span><span class="n">anonID</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">spydcm</span><span class="o">.</span><span class="n">anonymiseInPlace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">anonID</span><span class="o">=</span><span class="n">anonID</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;End anonymise&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setIsAnonymised</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span></div>



    <span class="k">def</span> <span class="nf">_checkAnonName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anonName</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">firstNames</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if anonName is valid and return anonName and anonID</span>
<span class="sd">        If anonName = SOFT then set an encoded name in meta file and retain PatientID - anonymise DICOMS</span>
<span class="sd">        If anonName = HARD then set encoded name in meta file to &quot;Unknown&quot; - anonymise DICOMS</span>
<span class="sd">        If anonName is None then anonymise DICOMS</span>
<span class="sd">        Else anonymise DICOMS with anonName for Name and PatientID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">anonName</span> <span class="o">==</span> <span class="s2">&quot;SOFT&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEncodedName</span><span class="p">(</span><span class="n">NAME</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">FIRST_NAMES</span><span class="o">=</span><span class="n">firstNames</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;PatientID&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">anonName</span> <span class="o">==</span> <span class="s2">&quot;HARD&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEncodedName</span><span class="p">(</span><span class="n">NAME</span><span class="o">=</span><span class="s1">&#39;Name-Unknown&#39;</span><span class="p">,</span> <span class="n">FIRST_NAMES</span><span class="o">=</span><span class="s1">&#39;FirstNames-Unknown&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">anonName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">anonName</span><span class="p">,</span> <span class="n">anonName</span>
    

<div class="viewcode-block" id="AbstractSubject.setIsAnonymised">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setIsAnonymised">[docs]</a>
    <span class="k">def</span> <span class="nf">setIsAnonymised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="s2">&quot;ANONYMISED&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></div>

    

<div class="viewcode-block" id="AbstractSubject.isAnonymised">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.isAnonymised">[docs]</a>
    <span class="k">def</span> <span class="nf">isAnonymised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;ANONYMISED&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.setEncodedName">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.setEncodedName">[docs]</a>
    <span class="k">def</span> <span class="nf">setEncodedName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="n">FIRST_NAMES</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">encodeString</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">),</span>
              <span class="s1">&#39;FIRST_NAMES&#39;</span><span class="p">:</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">encodeString</span><span class="p">(</span><span class="n">FIRST_NAMES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getName">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getName">[docs]</a>
    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnonymised</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;Name-Unknown&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;Name-Unknown&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractSubject.getName_FirstNames">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getName_FirstNames">[docs]</a>
    <span class="k">def</span> <span class="nf">getName_FirstNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnonymised</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">),</span> \
                    <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;FIRST_NAMES&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">firstNames</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">cleanString</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">cleanString</span><span class="p">(</span><span class="n">firstNames</span><span class="p">)</span></div>



    <span class="c1"># ------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSummary_list">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSummary_list">[docs]</a>
    <span class="k">def</span> <span class="nf">getSummary_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SubjectID&quot;</span><span class="p">,</span><span class="s2">&quot;PatientID&quot;</span><span class="p">,</span><span class="s2">&quot;Gender&quot;</span><span class="p">,</span><span class="s2">&quot;StudyDate&quot;</span><span class="p">,</span><span class="s2">&quot;NumberOfSeries&quot;</span><span class="p">,</span><span class="s2">&quot;SERIES_DECRIPTIONS&quot;</span><span class="p">]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;PatientID&#39;</span><span class="p">),</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;PatientSex&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">),</span> 
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;Series&#39;</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesDescriptionsStr</span><span class="p">()]</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ss</span></div>



<div class="viewcode-block" id="AbstractSubject.getAge">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getAge">[docs]</a>
    <span class="k">def</span> <span class="nf">getAge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns a float, and is slightly wrong in account of leap years.</span>
<span class="sd">        This is intentional.</span>
<span class="sd">        :return: years - float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;Age&quot;</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">birth</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;PatientBirthDate&quot;</span><span class="p">]</span>
            <span class="n">study</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;StudyDate&quot;</span><span class="p">]</span>
            <span class="n">age</span> <span class="o">=</span> <span class="p">(</span><span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">study</span><span class="p">)</span> <span class="o">-</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">birth</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">365.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">age</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="c1"># This may be case if pre-anonymisation has removed DOB but left PatientAge</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ageStr</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;PatientAge&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># Found no tags to provide age information</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ageStr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ageStrL</span> <span class="o">=</span> <span class="n">ageStr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">ageStrL</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">ageC</span> <span class="o">=</span> <span class="n">ageStrL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;m&quot;</span> <span class="ow">in</span> <span class="n">ageStrL</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mf">12.0</span>
                <span class="n">ageC</span> <span class="o">=</span> <span class="n">ageStrL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">ageStrL</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mf">52.0</span>
                <span class="n">ageC</span> <span class="o">=</span> <span class="n">ageStrL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">ageStrL</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">365.0</span>
                <span class="n">ageC</span> <span class="o">=</span> <span class="n">ageStrL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;h&quot;</span> <span class="ow">in</span> <span class="n">ageStrL</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">365.0</span> <span class="o">*</span> <span class="mf">24.0</span><span class="p">)</span>
                <span class="n">ageC</span> <span class="o">=</span> <span class="n">ageStrL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Now have a cleaned age string and a factor to convert to years (as decimal)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ageC</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="k">except</span><span class="p">:</span> <span class="c1"># Probably ValueError or UnboundLocalError (ageC not set) but catch all in case</span>
                <span class="c1"># failed so return nan</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">age</span></div>



<div class="viewcode-block" id="AbstractSubject.getGender">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getGender">[docs]</a>
    <span class="k">def</span> <span class="nf">getGender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()[</span><span class="s1">&#39;PatientSex&#39;</span><span class="p">]</span></div>

    

<div class="viewcode-block" id="AbstractSubject.isMale">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.isMale">[docs]</a>
    <span class="k">def</span> <span class="nf">isMale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGender</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span></div>



    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.zipUpSubject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.zipUpSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">zipUpSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputDirectory</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">EXCLUDE_RAW</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Will zip a subject and place in given output directory</span>

<span class="sd">        Args:</span>
<span class="sd">            outputDirectory (str): path to output directory</span>
<span class="sd">            fileName (str, optional): If given then this is zip filename, if not given then use subjID. Defaults to None.</span>
<span class="sd">            EXCLUDE_RAW (bool, optional): Set true to exclude RAW data - helpful for sharing. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: the results full archive name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
            <span class="n">fileName</span> <span class="o">+=</span> <span class="s2">&quot;.zip&quot;</span>
        <span class="n">archive_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">archive_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">EXCLUDE_RAW</span><span class="p">:</span> <span class="c1"># Exclude RAW subdirectory</span>
                    <span class="k">if</span> <span class="s1">&#39;RAW&#39;</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                        <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;RAW&#39;</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)</span>
                    <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">arcname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Zipped subject to </span><span class="si">{</span><span class="n">archive_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archive_name</span></div>



<div class="viewcode-block" id="AbstractSubject.delteAllButMeta">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.delteAllButMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">delteAllButMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all contents of subject except META data (leave directory srtructure). Often after &quot;archiveSubject&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 for success else 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start deleting all but META for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;META&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">fileFull</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileFull</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR deleting </span><span class="si">{</span><span class="n">fileFull</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished deleting all but META for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">. RESULT </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="AbstractSubject.rsyncToOtherDataroot">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.rsyncToOtherDataroot">[docs]</a>
    <span class="k">def</span> <span class="nf">rsyncToOtherDataroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherDataRoot</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">otherDataRoot</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2"> should exist and should be a directory.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">otherDataRoot</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Other root and data root are some - not performing rsync&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start rsyncToOtherDataroot for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;rsync&quot;</span><span class="p">,</span> <span class="s2">&quot;-av&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">otherDataRoot</span><span class="p">],</span> 
                                        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR performing rsync to other dataRoot: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>    
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR performing rsync to other dataRoot: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">otherDataRoot</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR rsyncToOtherDataroot for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2">: FileNotFoundError&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR rsyncToOtherDataroot for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2">: PermissionError&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR rsyncToOtherDataroot for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2">: shutil.Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">remoteDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">otherDataRoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">remoteDirectory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in rsyncToOtherDataroot. </span><span class="si">{</span><span class="n">remoteDirectory</span><span class="si">}</span><span class="s2"> does not exist. &quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">nFilesThisRoot</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">())</span>
        <span class="n">nFilesRemote</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="n">remoteDirectory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nFilesThisRoot</span> <span class="o">&gt;</span> <span class="n">nFilesRemote</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in rsyncToOtherDataroot. N-files-local=</span><span class="si">{</span><span class="n">nFilesThisRoot</span><span class="si">}</span><span class="s2">, N-files-remote=</span><span class="si">{</span><span class="n">nFilesRemote</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished rsyncToOtherDataroot for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">otherDataRoot</span><span class="si">}</span><span class="s2">. RESULT </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="AbstractSubject.archiveSubject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.archiveSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">archiveSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archiveRoot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move a subject to another dataRoot then delete local files (keep META and directory structure). </span>
<span class="sd">        Use case to build and run pipelines on high performance local ssd </span>
<span class="sd">        then to move subject to e.g. NAS - still available for future interrogation. </span>

<span class="sd">        NOTE: This relies on rsync for the transfer on linux / mac. Falls back to shutil opn Windows. </span>

<span class="sd">        Args:</span>
<span class="sd">            archiveRoot (str): directory path to the new dataRoot</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 for success else 1. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start archiveSubject for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">archiveRoot</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="c1"># Move the subejct</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsyncToOtherDataroot</span><span class="p">(</span><span class="n">archiveRoot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Clean up local:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delteAllButMeta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished archiveSubject for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">archiveRoot</span><span class="si">}</span><span class="s2">. RESULT </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>




    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSpydcmDicomStudy">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSpydcmDicomStudy">[docs]</a>
    <span class="k">def</span> <span class="nf">getSpydcmDicomStudy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomStudy</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">())</span></div>

    

<div class="viewcode-block" id="AbstractSubject.getSpydcmDicomSeries">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.AbstractSubject.getSpydcmDicomSeries">[docs]</a>
    <span class="k">def</span> <span class="nf">getSpydcmDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seNumber</span><span class="p">):</span>
        <span class="n">dcmdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seNumber</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomSeries</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="n">dcmdir</span><span class="p">)</span></div>
</div>


<span class="c1"># ====================================================================================================</span>
<span class="c1">#       LIST OF SUBJECTS CLASS</span>
<span class="c1"># ====================================================================================================</span>
<div class="viewcode-block" id="SubjectList">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList">[docs]</a>
<span class="k">class</span> <span class="nc">SubjectList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for a list of subjects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjList</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjList</span><span class="p">)</span>


<div class="viewcode-block" id="SubjectList.setByDirectory">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.setByDirectory">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setByDirectory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">getAllSubjects</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">listOfSubjects</span><span class="p">)</span></div>



<div class="viewcode-block" id="SubjectList.setBySNList">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.setBySNList">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setBySNList</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">snList</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
        <span class="n">subjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">data_root_dir</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">subject_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">snList</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">subjList</span><span class="p">)</span></div>



    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">subjID</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
    

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjNs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">subjN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> subjects of </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subjectPrefix</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="SubjectList.reduceToExist">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.reduceToExist">[docs]</a>
    <span class="k">def</span> <span class="nf">reduceToExist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">VERBOSE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">toRemove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">toRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing non-existant subjects: </span><span class="si">{</span><span class="n">toRemove</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">toRemove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>



<div class="viewcode-block" id="SubjectList.reduceToSet">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.reduceToSet">[docs]</a>
    <span class="k">def</span> <span class="nf">reduceToSet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">toRemove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">toRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">toRemove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>



<div class="viewcode-block" id="SubjectList.filterSubjectListByDOS">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.filterSubjectListByDOS">[docs]</a>
    <span class="k">def</span> <span class="nf">filterSubjectListByDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="p">,</span> <span class="n">dateEnd_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#TODO</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take list, return only those that match DOS or between start and end (inclusive) if dateEnd given</span>
<span class="sd">        :param subjList:</span>
<span class="sd">        :param dateOfScan_YYYYMMDD: str</span>
<span class="sd">        :param dateEnd_YYYYMMDD: str - optional </span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filteredMatchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">iDOS</span> <span class="o">=</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dateEnd_YYYYMMDD</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iDOS</span> <span class="o">==</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="p">:</span>
                        <span class="n">filteredMatchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iDOS</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iDOS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateEnd_YYYYMMDD</span><span class="p">)):</span>
                        <span class="n">filteredMatchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># maybe don&#39;t have tag, or wrong format</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">(</span><span class="n">filteredMatchList</span><span class="p">)</span></div>



<div class="viewcode-block" id="SubjectList.findSubjMatching_SubjN">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.findSubjMatching_SubjN">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatching_SubjN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjN</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param studyID (or examID): int</span>
<span class="sd">        :return: mi_subject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">iSubj</span><span class="o">.</span><span class="n">_subjN</span><span class="p">)</span> <span class="o">==</span> <span class="n">subjN</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">iSubj</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    

<div class="viewcode-block" id="SubjectList.findSubjMatchingStudyID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.findSubjMatchingStudyID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingStudyID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param studyID (or examID): int</span>
<span class="sd">        :return: mi_subject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;StudyID&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="n">studyID</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">iSubj</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    

<div class="viewcode-block" id="SubjectList.findSubjMatchingStudyUID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.findSubjMatchingStudyUID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingStudyUID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyUID</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;StudyInstanceUID&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">studyUID</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">iSubj</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="SubjectList.filterSubjectListByDOS_closest">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.filterSubjectListByDOS_closest">[docs]</a>
    <span class="k">def</span> <span class="nf">filterSubjectListByDOS_closest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dateOfScan_YYYY_MM_DD</span><span class="p">,</span> <span class="n">A_less_than_B</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce sList to one - closest to dateOfScan</span>
<span class="sd">        </span>
<span class="sd">        Keyword arguments:</span>
<span class="sd">        subjList -- list of KMR_CARDIAC objects</span>
<span class="sd">        dateOfScan_YYYY_MM_DD -- date of scan string to query</span>
<span class="sd">        A_less_than_B = check to force subjDateOfScan &lt;= dateOfScan query</span>
<span class="sd">        Return: subjList length one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dateDiffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_getDateDiff_days</span><span class="p">(</span><span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">),</span> <span class="n">dateOfScan_YYYY_MM_DD</span><span class="p">)</span> <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">A_less_than_B</span><span class="p">:</span> 
            <span class="n">minDiff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dateDiffs</span><span class="p">)</span>
            <span class="n">dateDiffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">minDiff</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dateDiffs</span><span class="p">]</span>
        <span class="n">indexKeep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dateDiffs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">indexKeep</span><span class="p">]]</span></div>



<div class="viewcode-block" id="SubjectList.findSubjMatchingPatientID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.findSubjMatchingPatientID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingPatientID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patientID</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tolerance_days</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param patientID:</span>
<span class="sd">        :param dateOfScan_YYYY_MM_DD: list of ints for DOS to fix ambiguity</span>
<span class="sd">        :return: SubjectList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patientID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">patientID</span><span class="p">)</span>
        <span class="n">matchList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;PatientID&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">patientID</span><span class="p">:</span>
                    <span class="n">matchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matchList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">dataEnd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">tolerance_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dataEnd_DT</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">tolerance_days</span><span class="p">)</span>
                <span class="n">dataEnd</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dateTime_to_dbString</span><span class="p">(</span><span class="n">dataEnd_DT</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matchList</span><span class="o">.</span><span class="n">filterSubjectListByDOS</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">,</span> <span class="n">dateEnd_YYYYMMDD</span><span class="o">=</span><span class="n">dataEnd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matchList</span></div>



<div class="viewcode-block" id="SubjectList.findSubjMatchingName">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.findSubjMatchingName">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nameStr</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decodePassword</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param nameStr:</span>
<span class="sd">        :param dateOfScan_YYYYMMDD: if given will use to filter list matching name</span>
<span class="sd">        :return: SubjectList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nameStr_l</span> <span class="o">=</span> <span class="n">nameStr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">matchList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">iName</span> <span class="o">=</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">decodePassword</span> <span class="o">==</span> <span class="s2">&quot;SubjID&quot;</span><span class="p">:</span>
                <span class="n">iName</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="n">iName</span><span class="p">,</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">decodePassword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iName</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="n">iName</span><span class="p">,</span> <span class="n">decodePassword</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nameStr_l</span> <span class="ow">in</span> <span class="n">iName</span><span class="p">:</span>
                    <span class="n">matchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matchList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">matchList</span><span class="o">.</span><span class="n">filterSubjectListByDOS</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matchList</span></div>



<div class="viewcode-block" id="SubjectList.writeSummaryCSV">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.SubjectList.writeSummaryCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">writeSummaryCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputFileName_csv</span><span class="p">,</span> <span class="n">extra_series_tags</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">isubj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ss</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="n">isubj</span><span class="o">.</span><span class="n">getInfoStr</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hh</span>
            <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">iSeriesTag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extra_series_tags</span><span class="p">):</span>
                <span class="n">seList</span> <span class="o">=</span> <span class="n">isubj</span><span class="o">.</span><span class="n">getDicomSeriesMeta</span><span class="p">(</span><span class="n">seriesDescription</span><span class="o">=</span><span class="n">iSeriesTag</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">seDict</span> <span class="ow">in</span> <span class="n">seList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">kkS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">hh2</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iSeriesTag</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kkS</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">header</span> <span class="o">+=</span> <span class="n">hh2</span>
                    <span class="n">ss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">seDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kkS</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="n">mi_utils</span><span class="o">.</span><span class="n">writeCSVFile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">outputFileName_csv</span><span class="p">)</span></div>
</div>


<span class="c1">### ====================================================================================================================</span>
<span class="c1">###  Helper functions for subject list</span>
<span class="c1">### ====================================================================================================================</span>
<span class="k">def</span> <span class="nf">_getAllSubjects</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RETURN_N</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">subjectPrefix</span><span class="p">)]</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iSubjObj</span> <span class="o">=</span> <span class="n">SubjClass</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjectPrefix</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dataRootDir</span><span class="si">}</span><span class="s2"> not valid subject&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iSubjObj</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">RETURN_N</span><span class="p">:</span>
                <span class="n">subjObjList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubjObj</span><span class="o">.</span><span class="n">subjN</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subjObjList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubjObj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dataRootDir</span><span class="si">}</span><span class="s2"> not valid subject&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subjObjList</span><span class="p">)</span>


<div class="viewcode-block" id="getAllSubjects">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getAllSubjects">[docs]</a>
<span class="k">def</span> <span class="nf">getAllSubjects</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_getAllSubjects</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">)</span></div>



<div class="viewcode-block" id="getAllSubjectsN">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getAllSubjectsN">[docs]</a>
<span class="k">def</span> <span class="nf">getAllSubjectsN</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_getAllSubjects</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">RETURN_N</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="getSubjects">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getSubjects">[docs]</a>
<span class="k">def</span> <span class="nf">getSubjects</span><span class="p">(</span><span class="n">subjectNList</span><span class="p">,</span> <span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjectNList</span><span class="p">]</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjObjList</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">exists</span><span class="p">()]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subjObjList</span><span class="p">)</span></div>



<div class="viewcode-block" id="subjNListToSubjObj">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.subjNListToSubjObj">[docs]</a>
<span class="k">def</span> <span class="nf">subjNListToSubjObj</span><span class="p">(</span><span class="n">subjNList</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">CHECK_EXIST</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="n">subjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">([</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">iN</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">iN</span> <span class="ow">in</span> <span class="n">subjNList</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">CHECK_EXIST</span><span class="p">:</span>
        <span class="n">subjList</span><span class="o">.</span><span class="n">reduceToExist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">subjList</span></div>



<div class="viewcode-block" id="WriteSubjectStudySummary">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.WriteSubjectStudySummary">[docs]</a>
<span class="k">def</span> <span class="nf">WriteSubjectStudySummary</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">summaryFilePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">summaryFilePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">summaryFilePath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">nowStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">summaryFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Summary_</span><span class="si">{</span><span class="n">nowStr</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
    <span class="n">misubjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="o">.</span><span class="n">setByDirectory</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">)</span>
    <span class="n">misubjList</span><span class="o">.</span><span class="n">writeSummaryCSV</span><span class="p">(</span><span class="n">summaryFilePath</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_getDateDiff_days</span><span class="p">(</span><span class="n">dateA</span><span class="p">,</span> <span class="n">dateB</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dateA</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">dateA</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">dateA</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dateB</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">dateB</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">dateB</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dateA</span> <span class="o">-</span> <span class="n">dateB</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>


<div class="viewcode-block" id="doDatesMatch">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.doDatesMatch">[docs]</a>
<span class="k">def</span> <span class="nf">doDatesMatch</span><span class="p">(</span><span class="n">dateA</span><span class="p">,</span> <span class="n">dateB</span><span class="p">,</span> <span class="n">tolerance_days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">dateDiff_days</span> <span class="o">=</span> <span class="n">_getDateDiff_days</span><span class="p">(</span><span class="n">dateA</span><span class="p">,</span> <span class="n">dateB</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dateDiff_days</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance_days</span></div>



<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="findSubjMatchingDicomStudyUID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.findSubjMatchingDicomStudyUID">[docs]</a>
<span class="k">def</span> <span class="nf">findSubjMatchingDicomStudyUID</span><span class="p">(</span><span class="n">dicomDir_OrData</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">dicomDir_OrData</span><span class="p">)</span>
        <span class="n">queryUID</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">queryUID</span> <span class="o">=</span> <span class="n">dicomDir_OrData</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">queryUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">SubjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="o">.</span><span class="n">setByDirectory</span><span class="p">(</span><span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SubjList</span><span class="o">.</span><span class="n">findSubjMatchingStudyUID</span><span class="p">(</span><span class="n">queryUID</span><span class="p">)</span></div>



<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="splitSubjID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.splitSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">splitSubjID</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip a subject ID to prefix and number</span>

<span class="sd">    Args:</span>
<span class="sd">        s (str): subject ID</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: prefix: str, number: int (if len 3 - then also suffix: str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># Split the string on one or more digits</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">part</span><span class="p">]</span>  <span class="c1"># Filter out empty parts</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="getNumberFromSubjID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getNumberFromSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">getNumberFromSubjID</span><span class="p">(</span><span class="n">subjID</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">subjID</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>



<div class="viewcode-block" id="findZeroPadding">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.findZeroPadding">[docs]</a>
<span class="k">def</span> <span class="nf">findZeroPadding</span><span class="p">(</span><span class="n">subjID</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">subjID</span><span class="p">)</span> <span class="c1"># first seq of numbers</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>  <span class="c1"># group numbers</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="c1"># </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># If no number found, return 0</span></div>



<div class="viewcode-block" id="guessSubjectPrefix">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.guessSubjectPrefix">[docs]</a>
<span class="k">def</span> <span class="nf">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guess the subject prefix by looking for common names in the dataRootDir</span>

<span class="sd">    Args:</span>
<span class="sd">        dataRootDir (str): path to root directory of subject filesystem database</span>
<span class="sd">        QUIET      (bool): Set True to suppress output (default False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: subject prefix string</span>

<span class="sd">    Exception:</span>
<span class="sd">        mi_utils.SubjPrefixError: is ambiguous</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
    <span class="n">allDir_subj</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefix_N_suffix</span> <span class="o">=</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_N_suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">prefix_N_suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span> 
            <span class="k">continue</span> <span class="c1"># directory not correct format - could not split to integer</span>
        <span class="n">allDir_subj</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">allDir_subj</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">SubjPrefixError</span><span class="p">(</span><span class="s2">&quot;Error guessing subject prefix - ambiguous - please provide&quot;</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">allDir_subj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
    <span class="n">maxCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">maxCount</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">SubjPrefixError</span><span class="p">(</span><span class="s2">&quot;Error guessing subject prefix - ambiguous - please provide&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">maxCount</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">QUIET</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;subjectPrefix determined from </span><span class="si">{</span><span class="n">dataRootDir</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<span class="c1">### ====================================================================================================================</span>
<span class="c1">###  Helper functions for building new or adding to subjects</span>
<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="buildSubjectID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.buildSubjectID">[docs]</a>
<span class="k">def</span> <span class="nf">buildSubjectID</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">padZeros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subjectPrefix</span>
    <span class="k">if</span> <span class="n">padZeros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">padZeros</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">default_pad_zeros</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subjectPrefix</span><span class="si">}{</span><span class="n">subjN</span><span class="si">:</span><span class="s2">0</span><span class="si">{</span><span class="n">padZeros</span><span class="si">}</span><span class="s2">d</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="getNextSubjN">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getNextSubjN">[docs]</a>
<span class="k">def</span> <span class="nf">getNextSubjN</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allNums</span> <span class="o">=</span> <span class="p">[</span><span class="n">getNumberFromSubjID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span>  <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">subjectPrefix</span><span class="p">))]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">allNums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="doesSubjectExist">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.doesSubjectExist">[docs]</a>
<span class="k">def</span> <span class="nf">doesSubjectExist</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padZeros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">padZeros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">padZeros</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">MIResearch_config</span><span class="o">.</span><span class="n">default_pad_zeros</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">,</span> <span class="n">padZeros</span><span class="o">=</span><span class="n">padZeros</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)))</span></div>



<div class="viewcode-block" id="getNextSubjID">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.getNextSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">getNextSubjID</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="n">getNextSubjN</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">),</span> <span class="n">subjectPrefix</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_createSubjectHelper</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="p">,</span> <span class="n">FORCE_NEW_SUBJ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">FORCE_NEW_SUBJ</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if a subject already exists with dicom data matching input</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">findSubjMatchingDicomStudyUID</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newSubj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Subject exists - so check nothing conflicting from inputs</span>
        <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subjNumber</span> <span class="o">!=</span> <span class="n">newSubj</span><span class="o">.</span><span class="n">subjN</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You supplied subject number </span><span class="si">{</span><span class="n">subjNumber</span><span class="si">}</span><span class="s2"> but a different subject matching your input dicom study exists at </span><span class="si">{</span><span class="n">newSubj</span><span class="o">.</span><span class="n">subjN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing subject </span><span class="si">{</span><span class="n">newSubj</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> - adding to&quot;</span><span class="p">)</span>
    
    <span class="c1"># If no subject exists matching the inputs - define a new subject (increment subjN from current in root directory)</span>
    <span class="k">if</span> <span class="n">newSubj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">subjNumber</span> <span class="o">=</span> <span class="n">_subjNumberHelper</span><span class="p">(</span><span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">)</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">SubjClass</span><span class="p">(</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">)</span>
    <span class="n">newSubj</span><span class="o">.</span><span class="n">QUIET</span> <span class="o">=</span> <span class="n">QUIET</span>

    <span class="c1"># Now have a subject - either newly created or existing and matching dicom data - load dicoms to subject:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
        <span class="n">newSubj</span><span class="o">.</span><span class="n">loadDicomsToSubject</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newSubj</span><span class="o">.</span><span class="n">loadSpydcmStudyToSubject</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">newSubj</span>


<span class="k">def</span> <span class="nf">_createNewSubject_Compressed</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;zip&#39;</span><span class="p">):</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromZip</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">):</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromTar</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currently only supporting .zip, .tar and .tar.gz compressed files&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listOfSubjects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More than one study in </span><span class="si">{</span><span class="n">compressedFile</span><span class="si">}</span><span class="s2"> - can not supply subjNumber&quot;</span><span class="p">)</span>
    <span class="n">newSubjList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listOfSubjects</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createSubjectHelper</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                        <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
        <span class="n">newSubjList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSubj</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newSubjList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">newSubjList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">newSubjList</span>


<span class="k">def</span> <span class="nf">_subjNumberHelper</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjNumber</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjNumber</span> <span class="o">=</span> <span class="n">getNextSubjN</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">doesSubjectExist</span><span class="p">(</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subject already exists - use loadDicomsToSubject method to add data to existing subject.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subjNumber</span>


<span class="k">def</span> <span class="nf">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                     <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">OTHER_DATA_DIR</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Destination does not exist: </span><span class="si">{</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">):</span>
            <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createNewSubject_Compressed</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> 
                                        <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newSubj</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot; Load dir does not exist&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO - new subject and just add whatever is there to raw. meta etc will be empty</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not find valid dicoms under </span><span class="si">{</span><span class="n">dicomDirToLoad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createSubjectHelper</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                    <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span> 
                                    <span class="n">FORCE_NEW_SUBJ</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">OTHER_DATA_DIR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newSubj</span><span class="o">.</span><span class="n">addOtherData</span><span class="p">(</span><span class="n">OTHER_DATA_DIR</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">newSubj</span>


<span class="k">def</span> <span class="nf">_createNew_OrAddTo_Subjects_Multi</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> 
                                       <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                       <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                       <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">anonName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;SOFT&quot;</span><span class="p">,</span> <span class="s2">&quot;HARD&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;anonName must be one of [None, &#39;SOFT&#39;, &#39;HARD&#39;] for multi-load&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot; Load dir does not exist&quot;</span><span class="p">)</span>
    <span class="n">dirsToLoad</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">)]</span>
    <span class="n">dirsToLoad</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dirsToLoad</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="n">dirsToLoad_checked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Destination does not exist&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iDir</span> <span class="ow">in</span> <span class="n">dirsToLoad</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">iDir</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirsToLoad_checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iDir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: No valid dicoms found under </span><span class="si">{</span><span class="n">iDir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirsToLoad_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not find valid dicoms under </span><span class="si">{</span><span class="n">multiDicomDirToLoad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">newSubjsList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iDir</span> <span class="ow">in</span> <span class="n">dirsToLoad_checked</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">iDir</span><span class="p">,</span> 
                                             <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span>
                                             <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span>
                                             <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span>
                                             <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span>
                                             <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span>
                                             <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">iDir</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">newSubj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">newSubjsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSubj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newSubjsList</span>


<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="createNew_OrAddTo_Subject">
<a class="viewcode-back" href="../../hurahura.html#hurahura.mi_subject.createNew_OrAddTo_Subject">[docs]</a>
<span class="k">def</span> <span class="nf">createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">LOAD_MULTI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">OTHER_DATA_DIR</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to create a new subject (or add data to already existing subject) from an input directory (or compressed file).</span>
<span class="sd">    Current compressed file tpyes supported: zip, tar, tar.gz</span>

<span class="sd">    Args:</span>
<span class="sd">        loadDirectory (str): the directory from which data to be loaded</span>
<span class="sd">        dataRoot (str): the root directory where subjects are stored</span>
<span class="sd">        SubjClass (subclass of AbstractClass, optional): subclass of AbstractClass. Defaults to AbstractSubject.</span>
<span class="sd">        subjNumber (int, optional): subject number to create or load to. Will take next available number if none given. Defaults to None.</span>
<span class="sd">        subjPrefix (str, optional): the subject prefix. If not given will attempt to guess from dataRoot. Defaults to None.</span>
<span class="sd">        anonName (str, optional): An anonymis name to give to this subject. Defaults to None.</span>
<span class="sd">        LOAD_MULTI (bool, optional): If true then each sub-directory in &quot;loadDirectory&quot; will be used to load a new subject. Defaults to False.</span>
<span class="sd">        IGNORE_UIDS (bool, optional): If true then ignore dicom UIDs and each sub-directory in &quot;loadDirectory&quot; will DEFINITLY be a new subject. Defaults to False.</span>
<span class="sd">        QUIET (bool, optional): If true will supress output. Defaults to False.</span>
<span class="sd">        OTHER_DATA_DIR (str, optional): If given then add other data (non-dicoms) from this directory to the subject. Defaults to None.</span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If incompatible arguments given (can not give subjNumber if LOAD_MULTI is given)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of Subject Objects added to or created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">SubjClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SubjClass</span> <span class="o">=</span> <span class="n">get_configured_subject_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">LOAD_MULTI</span> <span class="ow">and</span> <span class="p">(</span><span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can not pass subjNumber if LOAD_MULTI set True&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">LOAD_MULTI</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">(</span><span class="n">_createNew_OrAddTo_Subjects_Multi</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> 
                                       <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                       <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span> 
                                       <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> 
                                       <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">,</span>
                                       <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span>
                                       <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">))</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">([</span><span class="n">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> 
                                <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span>
                                <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span>
                                <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span>
                                <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> 
                                <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> 
                                <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span>
                                <span class="n">OTHER_DATA_DIR</span><span class="o">=</span><span class="n">OTHER_DATA_DIR</span><span class="p">)])</span></div>

    
<span class="c1">### ====================================================================================================================</span>
<span class="c1">### ====================================================================================================================</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Fraser M. Callaghan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>