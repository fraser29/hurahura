<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>miresearch.mi_subject &#8212; MIResearch 0.0.13 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css?v=f72dd004" />
    <script src="../../_static/documentation_options.js?v=9fc46840"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MIResearch 0.0.13 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">miresearch.mi_subject</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for miresearch.mi_subject</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Apr 26 10:59:36 2018</span>

<span class="sd">@author: Fraser M Callaghan</span>

<span class="sd">Classes for building standardised imaging projects. </span>
<span class="sd">Adapted for general use from KMR project. </span>


<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1">##</span>
<span class="kn">from</span> <span class="nn">spydcmtk</span> <span class="kn">import</span> <span class="n">spydcm</span>
<span class="kn">from</span> <span class="nn">miresearch</span> <span class="kn">import</span> <span class="n">mi_utils</span>

<span class="c1"># ====================================================================================================</span>
<span class="c1"># ====================================================================================================</span>


<span class="c1"># ====================================================================================================</span>
<span class="c1">#       ABSTRACT SUBJECT CLASS</span>
<span class="c1"># ====================================================================================================</span>
<div class="viewcode-block" id="AbstractSubject">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject">[docs]</a>
<span class="k">class</span> <span class="nc">AbstractSubject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract subject controlling most basic structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjectNumber</span><span class="p">,</span> 
                        <span class="n">dataRoot</span><span class="p">,</span> 
                        <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">DIRECTORY_STRUCTURE_TREE</span><span class="o">=</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">buildDirectoryStructureTree</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subjectNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Give subjectNumber (as int) or subjectPrefix as subjID&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subjectNumber</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">tSubjPrefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjN</span> <span class="o">=</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">subjectNumber</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="o">!=</span> <span class="n">tSubjPrefix</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">SubjPrefixError</span><span class="p">(</span><span class="s2">&quot;Subject prefix passed does not match subjectID passed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">tSubjPrefix</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c1"># subjectNumber passed as None - so use subjectPrefix as subjID (already check subjectPrefix not None)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjN</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span> <span class="o">=</span> <span class="n">dataRoot</span>
        <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">subjectPrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIRECTORY_STRUCTURE_TREE</span> <span class="o">=</span> <span class="n">DIRECTORY_STRUCTURE_TREE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BUILD_DIR_IF_NEED</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicomMetaTagList</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">DEFAULT_DICOM_META_TAG_LIST</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Class Methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>

    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Overriding methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span> <span class="o">&amp;</span> \
                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPrefix_Number</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">getPrefix_Number</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Properties</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span><span class="p">)</span>

    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Logging</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rr</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-7s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

    <span class="k">def</span> <span class="nf">_removeLogger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">logger_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">loggerDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">logger_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1">### Methods</span>
    <span class="c1">### ----------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.initDirectoryStructure">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.initDirectoryStructure">[docs]</a>
    <span class="k">def</span> <span class="nf">initDirectoryStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Study participant </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> exists at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2">. Updating directory structure&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIRECTORY_STRUCTURE_TREE</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">childrenList</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory structure correct for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getPrefix_Number">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getPrefix_Number">[docs]</a>
    <span class="k">def</span> <span class="nf">getPrefix_Number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span></div>


    <span class="c1">### LOADING</span>
    <span class="k">def</span> <span class="nf">_checkAnonName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anonName</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">firstNames</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">anonName</span> <span class="o">==</span> <span class="s2">&quot;SOFT&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEncodedName</span><span class="p">(</span><span class="n">NAME</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">FIRST_NAMES</span><span class="o">=</span><span class="n">firstNames</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">anonName</span> <span class="o">==</span> <span class="s2">&quot;HARD&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">anonName</span>

<div class="viewcode-block" id="AbstractSubject.loadDicomsToSubject">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.loadDicomsToSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">loadDicomsToSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicomFolderToLoad</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initDirectoryStructure</span><span class="p">()</span>
        <span class="n">patName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spydcm</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">dicomFolderToLoad</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">anonName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkAnonName</span><span class="p">(</span><span class="n">anonName</span><span class="p">,</span> <span class="n">patName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoadDicoms to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Don&#39;t log source here as could be identifying</span>
        <span class="c1"># self.logger.info(f&quot;LoadDicoms ({dicomFolderToLoad} ==&gt; {self.getDicomsDir()})&quot;)</span>
        <span class="n">d0</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">(),</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="n">dicomFolderToLoad</span><span class="p">)</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomStudy</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="n">dicomFolderToLoad</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">HIDE_PROGRESSBAR</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">writeToOrganisedFileStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalLoadSteps</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.loadSpydcmStudyToSubject">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.loadSpydcmStudyToSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">loadSpydcmStudyToSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spydcmData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initDirectoryStructure</span><span class="p">()</span>
        <span class="n">patName</span> <span class="o">=</span> <span class="n">spydcmData</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkAnonName</span><span class="p">(</span><span class="n">anonName</span><span class="p">,</span> <span class="n">patName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoadDicoms (spydcmtk data ==&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">d0</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">(),</span> <span class="n">spydcmData</span><span class="o">.</span><span class="n">getNumberOfDicoms</span><span class="p">()</span>
        <span class="n">spydcmData</span><span class="o">.</span><span class="n">writeToOrganisedFileStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalLoadSteps</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">dI</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_finalLoadSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initNumDicoms</span><span class="p">,</span> <span class="n">numDicomsToLoad</span><span class="p">):</span>
        <span class="n">finalNumDicoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countNumberOfDicoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial number of dicoms: </span><span class="si">{</span><span class="n">initNumDicoms</span><span class="si">}</span><span class="s2">, number to load: </span><span class="si">{</span><span class="n">numDicomsToLoad</span><span class="si">}</span><span class="s2">, final number dicoms: </span><span class="si">{</span><span class="n">finalNumDicoms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="n">FORCE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runPostLoadPipeLine</span><span class="p">()</span>

<div class="viewcode-block" id="AbstractSubject.runPostLoadPipeLine">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.runPostLoadPipeLine">[docs]</a>
    <span class="k">def</span> <span class="nf">runPostLoadPipeLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this is an abstract method for implementation by subclasses</span>
        <span class="k">pass</span></div>


    <span class="c1">### FOLDERS / FILES ------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.exists">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.exists">[docs]</a>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">())</span></div>


<div class="viewcode-block" id="AbstractSubject.getTopDir">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getTopDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getTopDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_getDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listOfDirsBeyondStudyDir</span><span class="p">,</span> <span class="n">BUILD_IF_NEED</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">listOfDirsBeyondStudyDir</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_getDir takes a list as first argument&quot;</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="o">*</span><span class="n">listOfDirsBeyondStudyDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">BUILD_IF_NEED</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILD_DIR_IF_NEED</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dd</span>

<div class="viewcode-block" id="AbstractSubject.getMetaDir">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getMetaDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">META</span><span class="p">])</span></div>


<div class="viewcode-block" id="AbstractSubject.getRawDir">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getRawDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getRawDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">RAW</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="AbstractSubject.getDicomsDir">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDicomsDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomsDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dirName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDir</span><span class="p">([</span><span class="n">mi_utils</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">DICOM</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dirName</span></div>

    
<div class="viewcode-block" id="AbstractSubject.renameSubjID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.renameSubjID">[docs]</a>
    <span class="k">def</span> <span class="nf">renameSubjID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newSubjID</span><span class="p">):</span>
        <span class="n">oldID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing subjID from </span><span class="si">{</span><span class="n">oldID</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">newSubjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; *** THIS WILL LIKELY HAVE BREAKING CONSEQUENCES ***&quot;</span><span class="p">)</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">newSubjID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newName</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">newName</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">(),</span> <span class="n">newName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">newSubjID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjN</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New logger after subjID changed from </span><span class="si">{</span><span class="n">oldID</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; *** THIS WILL LIKELY HAVE BREAKING CONSEQUENCES ***&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="n">FORCE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="c1">### META STUFF -----------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSeriesMetaCSV">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSeriesMetaCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="s1">&#39;ScanSeriesInfo.csv&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getSeriesMetaAsDataFrame">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSeriesMetaAsDataFrame">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaAsDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">(),</span>  <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.buildSeriesDataMetaCSV">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.buildSeriesDataMetaCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">buildSeriesDataMetaCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FORCE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">FORCE</span><span class="p">):</span>
            <span class="k">return</span> 
        <span class="n">seInfoList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmSE</span> <span class="ow">in</span> <span class="n">dcmStudy</span><span class="p">:</span>
                <span class="n">seInfoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcmSE</span><span class="o">.</span><span class="n">getSeriesInfoDict</span><span class="p">([</span><span class="s2">&quot;SeriesNumber&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;SeriesDescription&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;StudyDate&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;AcquisitionTime&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;InPlanePhaseEncodingDirection&quot;</span><span class="p">,</span> 
                                                            <span class="s2">&quot;PixelBandwidth&quot;</span><span class="p">]))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">seInfoList</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaCSV</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;buildSeriesDataMetaCSV&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.info">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.info">[docs]</a>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Print info for this subject</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="si">}</span><span class="s2"> scanned on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getStudyDate</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.printDicomsInfo">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.printDicomsInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">printDicomsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dicomFolderList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dicomFolderList</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.askUserForDicomSeriesNumber">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.askUserForDicomSeriesNumber">[docs]</a>
    <span class="k">def</span> <span class="nf">askUserForDicomSeriesNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printDicomsInfo</span><span class="p">()</span>
        <span class="n">seNum</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the dicom series number: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">seNum</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">findDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptionStr</span><span class="p">,</span> <span class="n">excludeStr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="n">descriptionStr</span><span class="p">,</span> <span class="n">excludeStr</span><span class="o">=</span><span class="n">excludeStr</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractSubject.getStartTime_EndTimeOfExam">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getStartTime_EndTimeOfExam">[docs]</a>
    <span class="k">def</span> <span class="nf">getStartTime_EndTimeOfExam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListOfSeNums</span><span class="p">()</span>
        <span class="n">Ns</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">NN</span><span class="p">)</span>
        <span class="n">Ne</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NN</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">Ne</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="n">Ne</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">))</span>
        <span class="n">endT_HHMMSS</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">endT</span><span class="p">,</span> <span class="s1">&#39;%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">Ns</span><span class="p">),</span> <span class="n">endT_HHMMSS</span></div>


<div class="viewcode-block" id="AbstractSubject.getTimeTakenForSeriesN_s">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getTimeTakenForSeriesN_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;ScanDuration&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="AbstractSubject.getHRForSeriesN">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getHRForSeriesN">[docs]</a>
    <span class="k">def</span> <span class="nf">getHRForSeriesN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;HeartRate&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="AbstractSubject.getStartTimeForSeriesN_HHMMSS">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getStartTimeForSeriesN_HHMMSS">[docs]</a>
    <span class="k">def</span> <span class="nf">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;AcquisitionTime&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="AbstractSubject.getDifferenceBetweenStartTimesOfTwoScans_s">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDifferenceBetweenStartTimesOfTwoScans_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getDifferenceBetweenStartTimesOfTwoScans_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seN1</span><span class="p">,</span> <span class="n">seN2</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">seN1</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStartTimeForSeriesN_HHMMSS</span><span class="p">(</span><span class="n">seN2</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">timeToDatetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span></div>


<div class="viewcode-block" id="AbstractSubject.getTotalScanTime_s">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getTotalScanTime_s">[docs]</a>
    <span class="k">def</span> <span class="nf">getTotalScanTime_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getListOfSeNums</span><span class="p">()</span>
        <span class="n">se</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">se</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">]</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDifferenceBetweenStartTimesOfTwoScans_s</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">se</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">se</span><span class="p">))</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeTakenForSeriesN_s</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">se</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span></div>


<div class="viewcode-block" id="AbstractSubject.findDicomSeries">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.findDicomSeries">[docs]</a>
    <span class="k">def</span> <span class="nf">findDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptionStr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="n">descriptionStr</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getSeriesNumbersMatchingDescriptionStr">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSeriesNumbersMatchingDescriptionStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptionStr</span><span class="p">):</span> <span class="c1"># FIXME what if mult studies</span>
        <span class="n">dcmStudy</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomStudy</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ONE_FILE_PER_DIR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dOut</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">dcmStudy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">descriptionStr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">iSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;SeriesDescription&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">dOut</span><span class="p">[</span><span class="n">iSeries</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">iSeries</span><span class="o">.</span><span class="n">getSeriesOutDirName</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dOut</span></div>


<div class="viewcode-block" id="AbstractSubject.getSeriesMetaValue">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSeriesMetaValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesMetaValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seNum</span><span class="p">,</span> <span class="n">varName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get meta value for given series naumber</span>

<span class="sd">        Args:</span>
<span class="sd">            seNum (int): series number</span>
<span class="sd">            varName (str): tag name, from: EchoTime FlipAngle HeartRate</span>
<span class="sd">                InPlanePhaseEncodingDirection InternalPulseSequenceName PulseSequenceName</span>
<span class="sd">                RepetitionTime ScanDuration SeriesDescription</span>
<span class="sd">                SeriesNumber SpacingBetweenSlices StartTime</span>
<span class="sd">                dCol dRow dSlice dTime</span>
<span class="sd">                nCols nRow nSlice nTime</span>

<span class="sd">        Returns:</span>
<span class="sd">            ANY: tag value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesMetaAsDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seNum</span><span class="p">,</span> <span class="n">varName</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="AbstractSubject.getMetaTagsFile">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getMetaTagsFile">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaTagsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaDir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">Tags</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.setTagValue">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.setTagValue">[docs]</a>
    <span class="k">def</span> <span class="nf">setTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="n">tag</span><span class="p">:</span><span class="n">value</span><span class="p">},</span> <span class="n">suffix</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getTagValue">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getTagValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="s1">&#39;Unknown&#39;</span><span class="p">):</span> <span class="c1"># FIXME is this done correctly</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getMetaDict">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getMetaDict">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get meta json file as dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            suffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Meta json file </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagsFile</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ff</span><span class="p">):</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">parseJsonToDictionary</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dd</span></div>


<div class="viewcode-block" id="AbstractSubject.getMetaTagValue">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getMetaTagValue">[docs]</a>
    <span class="k">def</span> <span class="nf">getMetaTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metaSuffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get specific tag from meta json file</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (str): Name of tag to return</span>
<span class="sd">            NOT_FOUND (ANY, optional): A default value to return if &quot;tag&quot; not found. Defaults to None.</span>
<span class="sd">            metaSuffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            e: OSError if meta json file not found</span>

<span class="sd">        Returns:</span>
<span class="sd">            ANY: tag value from json file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">(</span><span class="n">metaSuffix</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">NOT_FOUND</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NOT_FOUND</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="AbstractSubject.updateMetaFile">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.updateMetaFile">[docs]</a>
    <span class="k">def</span> <span class="nf">updateMetaFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metaDict</span><span class="p">,</span> <span class="n">metasuffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the meta json file</span>

<span class="sd">        Args:</span>
<span class="sd">            metaDict (dict): dictionary with key value pairs to update</span>
<span class="sd">            metasuffix (str, optional): Suffix of json file. Defaults to &quot;&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">(</span><span class="n">metasuffix</span><span class="p">)</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metaDict</span><span class="p">)</span>
        <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">writeDictionaryToJSON</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagsFile</span><span class="p">(</span><span class="n">metasuffix</span><span class="p">),</span> <span class="n">dd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updateMetaFile&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.buildDicomMeta">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.buildDicomMeta">[docs]</a>
    <span class="k">def</span> <span class="nf">buildDicomMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this uses pydicom - so tag names are different.</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ddFull</span> <span class="o">=</span> <span class="n">dcmStudies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getStudySummaryDict</span><span class="p">()</span>
        <span class="n">ddFull</span><span class="p">[</span><span class="s1">&#39;SubjectID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span>
        <span class="n">ddFull</span><span class="p">[</span><span class="s1">&#39;SubjN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjN</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dcmStudies</span><span class="p">)):</span>
            <span class="n">ddFull</span><span class="p">[</span><span class="s1">&#39;Series&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dcmStudies</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">getStudySummaryDict</span><span class="p">()[</span><span class="s1">&#39;Series&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">(</span><span class="n">ddFull</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.countNumberOfDicoms">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.countNumberOfDicoms">[docs]</a>
    <span class="k">def</span> <span class="nf">countNumberOfDicoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">countFilesInDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">())</span></div>

    
<div class="viewcode-block" id="AbstractSubject.getDicomSeriesDir_Description">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDicomSeriesDir_Description">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesDir_Description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesDescription</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesNumbersMatchingDescriptionStr</span><span class="p">(</span><span class="n">seriesDescription</span><span class="p">)</span>
        <span class="n">seNs</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">seN</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seNs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AbstractSubject.getDicomSeriesDir">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDicomSeriesDir">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomSeriesDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesNum</span><span class="p">,</span> <span class="n">seriesUID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">ONE_FILE_PER_DIR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seriesUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
                <span class="n">dcmSeries</span> <span class="o">=</span> <span class="n">dcmStudy</span><span class="o">.</span><span class="n">getSeriesByUID</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## ERROR: Series with UID: </span><span class="si">{</span><span class="n">seriesUID</span><span class="si">}</span><span class="s2"> NOT FOUND&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
                <span class="n">dcmSeries</span> <span class="o">=</span> <span class="n">dcmStudy</span><span class="o">.</span><span class="n">getSeriesByID</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">dcmSeries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## ERROR: Series with SE number: </span><span class="si">{</span><span class="n">seriesNum</span><span class="si">}</span><span class="s2"> NOT FOUND&quot;</span><span class="p">)</span>
        <span class="n">dirName</span> <span class="o">=</span> <span class="n">dcmSeries</span><span class="o">.</span><span class="n">getRootDir</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dirName</span></div>


<div class="viewcode-block" id="AbstractSubject.getDicomFile">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDicomFile">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesNum</span><span class="p">,</span> <span class="n">instanceNum</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1">#FIXME Note - at some point the files were named incorrectly - this has to work around this... Could be better</span>
        <span class="c1"># (and the number of leading zeros changed)</span>
        <span class="c1"># possible fix - work it out on per subject basis</span>
        <span class="n">dicomf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">),</span> <span class="s1">&#39;IM-</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%04d</span><span class="s1">.dcm&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">,</span> <span class="n">instanceNum</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dicomf</span><span class="p">):</span>
            <span class="n">dicomf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">),</span>
                                  <span class="s1">&#39;IM-</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%04d</span><span class="s1">.dcm&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">instanceNum</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dicomf</span><span class="p">):</span>
            <span class="n">dicomf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">seriesNum</span><span class="p">),</span>
                                  <span class="s1">&#39;IM-</span><span class="si">%05d</span><span class="s1">-</span><span class="si">%05d</span><span class="s1">.dcm&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seriesNum</span><span class="p">,</span> <span class="n">instanceNum</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dicomf</span></div>


<div class="viewcode-block" id="AbstractSubject.getDicomFoldersListStr">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getDicomFoldersListStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getDicomFoldersListStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FULL</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">excludeSeNums</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dFolders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dcmStudies</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">ONE_FILE_PER_DIR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dcmStudy</span> <span class="ow">in</span> <span class="n">dcmStudies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iSeries</span> <span class="ow">in</span> <span class="n">dcmStudy</span><span class="p">:</span>
                <span class="n">dFolders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSeries</span><span class="o">.</span><span class="n">getRootDir</span><span class="p">())</span>
        <span class="n">dS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dFolders</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">instanceNumberSortKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">FULL</span><span class="p">:</span>
            <span class="n">dS</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dS</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">dS</span>
        <span class="k">if</span> <span class="n">excludeSeNums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">excludeSeNums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seN</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">seN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">dcmDirList</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomSeriesDir</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seN</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludeSeNums</span><span class="p">]</span>
        <span class="n">dcmDirList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dcmDirList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">instanceNumberSortKey</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dcmDirList</span></div>


<div class="viewcode-block" id="AbstractSubject.getListOfSeNums">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getListOfSeNums">[docs]</a>
    <span class="k">def</span> <span class="nf">getListOfSeNums</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">se</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="n">FULL</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">se</span></div>


<div class="viewcode-block" id="AbstractSubject.getStudyID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getStudyID">[docs]</a>
    <span class="k">def</span> <span class="nf">getStudyID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">studyID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;StudyID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">studyID</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">studyID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s2">&quot;ScannerStudyID&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">studyID</span></div>

    
<div class="viewcode-block" id="AbstractSubject.getSeriesDescriptionsStr">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSeriesDescriptionsStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getSeriesDescriptionsStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomFoldersListStr</span><span class="p">(</span><span class="n">FULL</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>



<div class="viewcode-block" id="AbstractSubject.getStudyDate">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getStudyDate">[docs]</a>
    <span class="k">def</span> <span class="nf">getStudyDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RETURN_Datetime</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">dos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RETURN_Datetime</span><span class="p">:</span>
            <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">dos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dos</span></div>


<div class="viewcode-block" id="AbstractSubject.getInfoStr">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getInfoStr">[docs]</a>
    <span class="k">def</span> <span class="nf">getInfoStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extraKeys</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># Return values_list, info_keys:</span>
        <span class="c1">#   list of values for info keys (+ age). </span>
        <span class="c1">#   header keys</span>
        <span class="n">infoKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SubjectID&#39;</span><span class="p">,</span> <span class="s1">&#39;SubjN&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientBirthDate&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientSex&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">extraKeys</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%5.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAge</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infoKeys</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">aa</span><span class="p">],</span> <span class="n">infoKeys</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span></div>


    <span class="c1"># ------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.anonymise">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.anonymise">[docs]</a>
    <span class="k">def</span> <span class="nf">anonymise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">anonName</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anonName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
                <span class="n">anonName</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Still anonymise, but let program choose the new anonName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Anonymise in place&#39;</span><span class="p">)</span>
        <span class="n">spydcm</span><span class="o">.</span><span class="n">anonymiseInPlace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">(),</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setIsAnonymised</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildDicomMeta</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractSubject.setIsAnonymised">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.setIsAnonymised">[docs]</a>
    <span class="k">def</span> <span class="nf">setIsAnonymised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">({</span><span class="s2">&quot;ANONYMISED&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></div>

    
<div class="viewcode-block" id="AbstractSubject.isAnonymised">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.isAnonymised">[docs]</a>
    <span class="k">def</span> <span class="nf">isAnonymised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;ANONYMISED&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.setEncodedName">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.setEncodedName">[docs]</a>
    <span class="k">def</span> <span class="nf">setEncodedName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="n">FIRST_NAMES</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        funct to add name after (will encode)</span>
<span class="sd">        :param NAME:</span>
<span class="sd">        :param FIRST_NAMES:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">encodeString</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">),</span>
              <span class="s1">&#39;FIRST_NAMES&#39;</span><span class="p">:</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">encodeString</span><span class="p">(</span><span class="n">FIRST_NAMES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaFile</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getName">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getName">[docs]</a>
    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnonymised</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;Name-Unknown&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;Name-Unknown&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractSubject.getName_FirstNames">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getName_FirstNames">[docs]</a>
    <span class="k">def</span> <span class="nf">getName_FirstNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnonymised</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">),</span> \
                <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;FIRST_NAMES&quot;</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span></div>



    <span class="c1"># ------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSummary_list">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSummary_list">[docs]</a>
    <span class="k">def</span> <span class="nf">getSummary_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SubjectID&quot;</span><span class="p">,</span><span class="s2">&quot;PatientID&quot;</span><span class="p">,</span><span class="s2">&quot;Gender&quot;</span><span class="p">,</span><span class="s2">&quot;StudyDate&quot;</span><span class="p">,</span><span class="s2">&quot;NumberOfSeries&quot;</span><span class="p">,</span><span class="s2">&quot;SERIES_DECRIPTIONS&quot;</span><span class="p">]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;PatientID&#39;</span><span class="p">),</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;PatientSex&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">),</span> 
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetaTagValue</span><span class="p">(</span><span class="s1">&#39;Series&#39;</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeriesDescriptionsStr</span><span class="p">()]</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ss</span></div>


<div class="viewcode-block" id="AbstractSubject.getAge">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getAge">[docs]</a>
    <span class="k">def</span> <span class="nf">getAge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns a float, and is slightly wrong in account of leap years.</span>
<span class="sd">        This is intentional.</span>
<span class="sd">        :return: years - float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">birth</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;PatientBirthDate&quot;</span><span class="p">]</span>
            <span class="n">study</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s2">&quot;StudyDate&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">study</span><span class="p">)</span> <span class="o">-</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTools</span><span class="o">.</span><span class="n">dbDateToDateTime</span><span class="p">(</span><span class="n">birth</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">365.0</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="AbstractSubject.getGender">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getGender">[docs]</a>
    <span class="k">def</span> <span class="nf">getGender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetaDict</span><span class="p">()[</span><span class="s1">&#39;PatientSex&#39;</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="AbstractSubject.isMale">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.isMale">[docs]</a>
    <span class="k">def</span> <span class="nf">isMale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGender</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span></div>


    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.zipUpSubject">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.zipUpSubject">[docs]</a>
    <span class="k">def</span> <span class="nf">zipUpSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputDirectory</span><span class="p">,</span> <span class="n">EXCLUDE_RAW</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">archive_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">archive_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getTopDir</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">EXCLUDE_RAW</span><span class="p">:</span> <span class="c1"># Exclude RAW subdirectory</span>
                    <span class="k">if</span> <span class="s1">&#39;RAW&#39;</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                        <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;RAW&#39;</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataRoot</span><span class="p">)</span>
                    <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">arcname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Zipped subject to </span><span class="si">{</span><span class="n">archive_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archive_name</span></div>


    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AbstractSubject.getSpydcmDicomStudy">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.AbstractSubject.getSpydcmDicomStudy">[docs]</a>
    <span class="k">def</span> <span class="nf">getSpydcmDicomStudy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">DicomStudy</span><span class="o">.</span><span class="n">setFromDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDicomsDir</span><span class="p">())</span></div>
</div>


<span class="c1"># ====================================================================================================</span>
<span class="c1">#       LIST OF SUBJECTS CLASS</span>
<span class="c1"># ====================================================================================================</span>
<div class="viewcode-block" id="SubjectList">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList">[docs]</a>
<span class="k">class</span> <span class="nc">SubjectList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for a list of subjects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjList</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjList</span><span class="p">)</span>


<div class="viewcode-block" id="SubjectList.setByDirectory">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.setByDirectory">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setByDirectory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">getAllSubjects</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">listOfSubjects</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">subjID</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjNs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">subjN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> subjects of </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subjectPrefix</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="SubjectList.reduceToExist">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.reduceToExist">[docs]</a>
    <span class="k">def</span> <span class="nf">reduceToExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">toRemove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">toRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">toRemove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>


<div class="viewcode-block" id="SubjectList.reduceToSet">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.reduceToSet">[docs]</a>
    <span class="k">def</span> <span class="nf">reduceToSet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">toRemove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">toRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">toRemove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>


<div class="viewcode-block" id="SubjectList.filterSubjectListByDOS">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.filterSubjectListByDOS">[docs]</a>
    <span class="k">def</span> <span class="nf">filterSubjectListByDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="p">,</span> <span class="n">dateEnd_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#TODO</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take list, return only those that match DOS or between start and end (inclusive) if dateEnd given</span>
<span class="sd">        :param subjList:</span>
<span class="sd">        :param dateOfScan_YYYYMMDD: str</span>
<span class="sd">        :param dateEnd_YYYYMMDD: str - optional </span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filteredMatchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">iDOS</span> <span class="o">=</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dateEnd_YYYYMMDD</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iDOS</span> <span class="o">==</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="p">:</span>
                        <span class="n">filteredMatchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iDOS</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iDOS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateEnd_YYYYMMDD</span><span class="p">)):</span>
                        <span class="n">filteredMatchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># maybe don&#39;t have tag, or wrong format</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">(</span><span class="n">filteredMatchList</span><span class="p">)</span></div>


<div class="viewcode-block" id="SubjectList.findSubjMatchingStudyID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.findSubjMatchingStudyID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingStudyID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param studyID (or examID): int</span>
<span class="sd">        :return: mi_subject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;StudyID&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="n">studyID</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">iSubj</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="SubjectList.findSubjMatchingStudyUID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.findSubjMatchingStudyUID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingStudyUID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyUID</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;StudyInstanceUID&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">studyUID</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">iSubj</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SubjectList.findSubjMatchingPatientID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.findSubjMatchingPatientID">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingPatientID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patientID</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param patientID:</span>
<span class="sd">        :param dateOfScan_YYYY_MM_DD: list of ints for DOS to fix ambiguity</span>
<span class="sd">        :return: SubjectList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patientID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">patientID</span><span class="p">)</span>
        <span class="n">matchList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;PatientID&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">patientID</span><span class="p">:</span>
                    <span class="n">matchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matchList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">matchList</span><span class="o">.</span><span class="n">filterSubjectListByDOS</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matchList</span></div>


<div class="viewcode-block" id="SubjectList.findSubjMatchingName">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.findSubjMatchingName">[docs]</a>
    <span class="k">def</span> <span class="nf">findSubjMatchingName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nameStr</span><span class="p">,</span> <span class="n">dateOfScan_YYYYMMDD</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decodePassword</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param nameStr:</span>
<span class="sd">        :param dateOfScan_YYYYMMDD: if given will use to filter list matching name</span>
<span class="sd">        :return: SubjectList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nameStr_l</span> <span class="o">=</span> <span class="n">nameStr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">matchList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iSubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">iName</span> <span class="o">=</span> <span class="n">iSubj</span><span class="o">.</span><span class="n">getTagValue</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">decodePassword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iName</span> <span class="o">=</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">decodeString</span><span class="p">(</span><span class="n">iName</span><span class="p">,</span> <span class="n">decodePassword</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nameStr_l</span> <span class="ow">in</span> <span class="n">iName</span><span class="p">:</span>
                    <span class="n">matchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iSubj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matchList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">matchList</span><span class="o">.</span><span class="n">filterSubjectListByDOS</span><span class="p">(</span><span class="n">dateOfScan_YYYYMMDD</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matchList</span></div>


<div class="viewcode-block" id="SubjectList.writeSummaryCSV">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.SubjectList.writeSummaryCSV">[docs]</a>
    <span class="k">def</span> <span class="nf">writeSummaryCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputFileName_csv</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">isubj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ss</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="n">isubj</span><span class="o">.</span><span class="n">getInfoStr</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hh</span>
        <span class="n">mi_utils</span><span class="o">.</span><span class="n">writeCsvFile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">outputFileName_csv</span><span class="p">)</span></div>
</div>


<span class="c1">### ====================================================================================================================</span>
<span class="c1">###  Helper functions for subject list</span>
<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="getAllSubjects">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.getAllSubjects">[docs]</a>
<span class="k">def</span> <span class="nf">getAllSubjects</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subjObjList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRootDir</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dataRootDir</span><span class="si">}</span><span class="s2"> not valid subject&quot;</span><span class="p">)</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjObjList</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">exists</span><span class="p">()]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subjObjList</span><span class="p">)</span></div>


<div class="viewcode-block" id="getSubjects">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.getSubjects">[docs]</a>
<span class="k">def</span> <span class="nf">getSubjects</span><span class="p">(</span><span class="n">subjectNList</span><span class="p">,</span> <span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjectNList</span><span class="p">]</span>
    <span class="n">subjObjList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjObjList</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">exists</span><span class="p">()]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subjObjList</span><span class="p">)</span></div>


<div class="viewcode-block" id="subjNListToSubjObj">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.subjNListToSubjObj">[docs]</a>
<span class="k">def</span> <span class="nf">subjNListToSubjObj</span><span class="p">(</span><span class="n">subjNList</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">,</span> <span class="n">CHECK_EXIST</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">subjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="p">([</span><span class="n">SubjClass</span><span class="p">(</span><span class="n">iN</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">iN</span> <span class="ow">in</span> <span class="n">subjNList</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">CHECK_EXIST</span><span class="p">:</span>
        <span class="n">subjList</span><span class="o">.</span><span class="n">reduceToExist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">subjList</span></div>


<div class="viewcode-block" id="WriteSubjectStudySummary">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.WriteSubjectStudySummary">[docs]</a>
<span class="k">def</span> <span class="nf">WriteSubjectStudySummary</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">summaryFilePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">summaryFilePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">summaryFilePath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">nowStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">summaryFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Summary_</span><span class="si">{</span><span class="n">nowStr</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
    <span class="n">misubjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="o">.</span><span class="n">setByDirectory</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">misubjList</span><span class="o">.</span><span class="n">writeSummaryCSV</span><span class="p">(</span><span class="n">summaryFilePath</span><span class="p">)</span></div>


<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="findSubjMatchingDicomStudyUID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.findSubjMatchingDicomStudyUID">[docs]</a>
<span class="k">def</span> <span class="nf">findSubjMatchingDicomStudyUID</span><span class="p">(</span><span class="n">dicomDir_OrData</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">dicomDir_OrData</span><span class="p">)</span>
        <span class="n">queryUID</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">queryUID</span> <span class="o">=</span> <span class="n">dicomDir_OrData</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="n">ifNotFound</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">queryUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">SubjList</span> <span class="o">=</span> <span class="n">SubjectList</span><span class="o">.</span><span class="n">setByDirectory</span><span class="p">(</span><span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SubjList</span><span class="o">.</span><span class="n">findSubjMatchingStudyUID</span><span class="p">(</span><span class="n">queryUID</span><span class="p">)</span></div>



<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="splitSubjID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.splitSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">splitSubjID</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):])</span>
    <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">number</span></div>


<div class="viewcode-block" id="getNumberFromSubjID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.getNumberFromSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">getNumberFromSubjID</span><span class="p">(</span><span class="n">subjID</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">subjID</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="guessSubjectPrefix">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.guessSubjectPrefix">[docs]</a>
<span class="k">def</span> <span class="nf">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guess the subject prefix by looking for common names in the dataRootDir</span>

<span class="sd">    Args:</span>
<span class="sd">        dataRootDir (str): path to root directory of subject filesystem database</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: subject prefix string</span>

<span class="sd">    Exception:</span>
<span class="sd">        mi_utils.SubjPrefixError: is ambiguous</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
    <span class="n">allDir_subj</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allDir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">splitSubjID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> 
            <span class="k">continue</span> <span class="c1"># directory not correct format - could not split to integer</span>
        <span class="n">allDir_subj</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">allDir_subj</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">SubjPrefixError</span><span class="p">(</span><span class="s2">&quot;Error guessing subject prefix - ambiguous&quot;</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">allDir_subj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
    <span class="n">maxCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">maxCount</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">mi_utils</span><span class="o">.</span><span class="n">SubjPrefixError</span><span class="p">(</span><span class="s2">&quot;Error guessing subject prefix - ambiguous&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">[</span><span class="n">maxCount</span><span class="p">]</span></div>


<span class="c1">### ====================================================================================================================</span>
<span class="c1">###  Helper functions for building new or adding to subjects</span>
<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="buildSubjectID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.buildSubjectID">[docs]</a>
<span class="k">def</span> <span class="nf">buildSubjectID</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subjectPrefix</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subjectPrefix</span><span class="si">}{</span><span class="n">subjN</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="getNextSubjN">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.getNextSubjN">[docs]</a>
<span class="k">def</span> <span class="nf">getNextSubjN</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="n">allNums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">subjectPrefix</span><span class="p">):])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span>  <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">subjectPrefix</span><span class="p">))]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">allNums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="doesSubjectExist">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.doesSubjectExist">[docs]</a>
<span class="k">def</span> <span class="nf">doesSubjectExist</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="n">subjN</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">)))</span></div>


<div class="viewcode-block" id="getNextSubjID">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.getNextSubjID">[docs]</a>
<span class="k">def</span> <span class="nf">getNextSubjID</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjectPrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjectPrefix</span> <span class="o">=</span> <span class="n">guessSubjectPrefix</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buildSubjectID</span><span class="p">(</span><span class="n">getNextSubjN</span><span class="p">(</span><span class="n">dataRootDir</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="p">),</span> <span class="n">subjectPrefix</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_createSubjectHelper</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="p">,</span> <span class="n">FORCE_NEW_SUBJ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">FORCE_NEW_SUBJ</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">findSubjMatchingDicomStudyUID</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newSubj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subjNumber</span> <span class="o">!=</span> <span class="n">newSubj</span><span class="o">.</span><span class="n">subjN</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You supplied subject number </span><span class="si">{</span><span class="n">subjNumber</span><span class="si">}</span><span class="s2"> but a different subject matching your input dicom study exists at </span><span class="si">{</span><span class="n">newSubj</span><span class="o">.</span><span class="n">subjN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing subject </span><span class="si">{</span><span class="n">newSubj</span><span class="o">.</span><span class="n">subjID</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2"> - adding to&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newSubj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">subjNumber</span> <span class="o">=</span> <span class="n">_subjNumberHelper</span><span class="p">(</span><span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">)</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">SubjClass</span><span class="p">(</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjectPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">)</span>
    <span class="n">newSubj</span><span class="o">.</span><span class="n">QUIET</span> <span class="o">=</span> <span class="n">QUIET</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">)</span>
        <span class="n">newSubj</span><span class="o">.</span><span class="n">loadDicomsToSubject</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">newSubj</span><span class="o">.</span><span class="n">loadSpydcmStudyToSubject</span><span class="p">(</span><span class="n">dicomDir_orData</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">newSubj</span>

<span class="k">def</span> <span class="nf">_createNewSubject_Compressed</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">,</span> 
                                <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;zip&#39;</span><span class="p">):</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromZip</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">compressedFile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">):</span>
        <span class="n">listOfSubjects</span> <span class="o">=</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">dcmTK</span><span class="o">.</span><span class="n">ListOfDicomStudies</span><span class="o">.</span><span class="n">setFromTar</span><span class="p">(</span><span class="n">compressedFile</span><span class="p">,</span> <span class="n">HIDE_PROGRESSBAR</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currently only supporting .zip, .tar and .tar.gz compressed files&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listOfSubjects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More than one study in </span><span class="si">{</span><span class="n">compressedFile</span><span class="si">}</span><span class="s2"> - can not supply subjNumber&quot;</span><span class="p">)</span>
    <span class="n">newSubjList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listOfSubjects</span><span class="p">:</span>
        <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createSubjectHelper</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                        <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
        <span class="n">newSubjList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSubj</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newSubjList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">newSubjList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">newSubjList</span>

<span class="k">def</span> <span class="nf">_subjNumberHelper</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjNumber</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subjNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subjNumber</span> <span class="o">=</span> <span class="n">getNextSubjN</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">doesSubjectExist</span><span class="p">(</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subject already exists - use loadDicomsToSubject method to add data to existing subject.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subjNumber</span>

<span class="k">def</span> <span class="nf">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">,</span> 
                     <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">):</span>
            <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createNewSubject_Compressed</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> 
                                        <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newSubj</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot; Load dir does not exist&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not find valid dicoms under </span><span class="si">{</span><span class="n">dicomDirToLoad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Destination does not exist: </span><span class="si">{</span><span class="n">dataRoot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">newSubj</span> <span class="o">=</span> <span class="n">_createSubjectHelper</span><span class="p">(</span><span class="n">dicomDirToLoad</span><span class="p">,</span> <span class="n">SubjClass</span><span class="p">,</span> <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span> <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                    <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span> 
                                    <span class="n">FORCE_NEW_SUBJ</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">newSubj</span>

<span class="k">def</span> <span class="nf">_createNew_OrAddTo_Subjects_Multi</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> 
                                       <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                       <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot; Load dir does not exist&quot;</span><span class="p">)</span>
    <span class="n">dirsToLoad</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">multiDicomDirToLoad</span><span class="p">)]</span>
    <span class="n">dirsToLoad</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dirsToLoad</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="n">dirsToLoad_checked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataRoot</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Destination does not exist&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iDir</span> <span class="ow">in</span> <span class="n">dirsToLoad</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spydcm</span><span class="o">.</span><span class="n">returnFirstDicomFound</span><span class="p">(</span><span class="n">iDir</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirsToLoad_checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iDir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirsToLoad_checked</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not find valid dicoms under </span><span class="si">{</span><span class="n">multiDicomDirToLoad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">newSubjsList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iDir</span> <span class="ow">in</span> <span class="n">dirsToLoad_checked</span><span class="p">:</span>
        <span class="n">newSubjsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">iDir</span><span class="p">,</span> 
                                             <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span>
                                             <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span>
                                             <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span>
                                             <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span>
                                             <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">newSubjsList</span>

<span class="c1">### ====================================================================================================================</span>
<div class="viewcode-block" id="createNew_OrAddTo_Subject">
<a class="viewcode-back" href="../../miresearch.html#miresearch.mi_subject.createNew_OrAddTo_Subject">[docs]</a>
<span class="k">def</span> <span class="nf">createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> <span class="n">dataRoot</span><span class="p">,</span> <span class="n">SubjClass</span><span class="o">=</span><span class="n">AbstractSubject</span><span class="p">,</span> 
                           <span class="n">subjNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjPrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anonName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">LOAD_MULTI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">QUIET</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to create a new subject (or add data to already existing subject) from an input directory (or compressed file).</span>
<span class="sd">    Current compressed file tpyes supported: zip, tar, tar.gz</span>

<span class="sd">    Args:</span>
<span class="sd">        loadDirectory (str): the directory from which data to be loaded</span>
<span class="sd">        dataRoot (str): the root directory where subjects are stored</span>
<span class="sd">        SubjClass (subclass of AbstractClass, optional): subclass of AbstractClass. Defaults to AbstractSubject.</span>
<span class="sd">        subjNumber (int, optional): subject number to create or load to. Will take next available number if none given. Defaults to None.</span>
<span class="sd">        subjPrefix (str, optional): the subject prefix. If not given will attempt to guess from dataRoot. Defaults to None.</span>
<span class="sd">        anonName (str, optional): An anonymis name to give to this subject. Defaults to None.</span>
<span class="sd">        LOAD_MULTI (bool, optional): If true then each sub-directory in &quot;loadDirectory&quot; will be used to load a new subject. Defaults to False.</span>
<span class="sd">        IGNORE_UIDS (bool, optional): If true then ignore dicom UIDs and each sub-directory in &quot;loadDirectory&quot; will DEFINITLY be a new subject. Defaults to False.</span>
<span class="sd">        QUIET (bool, optional): If true will supress output. Defaults to False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If incompatible arguments given (can not give subjNumber if LOAD_MULTI is given)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of Subject Objects added to or created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">LOAD_MULTI</span> <span class="ow">and</span> <span class="p">((</span><span class="n">subjNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">anonName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can not pass subjNumber if LOAD_MULTI set True&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">LOAD_MULTI</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">(</span><span class="n">_createNew_OrAddTo_Subjects_Multi</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> 
                                       <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span> 
                                       <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span> 
                                       <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> 
                                       <span class="n">IGNORE_UIDS</span><span class="o">=</span><span class="n">IGNORE_UIDS</span><span class="p">,</span>
                                       <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SubjectList</span><span class="p">([</span><span class="n">_createNew_OrAddTo_Subject</span><span class="p">(</span><span class="n">loadDirectory</span><span class="p">,</span> 
                                <span class="n">dataRoot</span><span class="o">=</span><span class="n">dataRoot</span><span class="p">,</span>
                                <span class="n">SubjClass</span><span class="o">=</span><span class="n">SubjClass</span><span class="p">,</span>
                                <span class="n">subjNumber</span><span class="o">=</span><span class="n">subjNumber</span><span class="p">,</span>
                                <span class="n">subjPrefix</span><span class="o">=</span><span class="n">subjPrefix</span><span class="p">,</span> 
                                <span class="n">anonName</span><span class="o">=</span><span class="n">anonName</span><span class="p">,</span> 
                                <span class="n">QUIET</span><span class="o">=</span><span class="n">QUIET</span><span class="p">)])</span></div>

    
<span class="c1">### ====================================================================================================================</span>
<span class="c1">### ====================================================================================================================</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MIResearch 0.0.13 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">miresearch.mi_subject</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Fraser M. Callaghan.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>